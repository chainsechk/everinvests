---
// src/components/SignalCard.astro
import { formatTime as formatTimeI18n, getLocaleFromUrl, useTranslations, translateBias, l, type Locale } from "../lib/i18n";

interface Props {
  category: "crypto" | "forex" | "stocks";
  bias: string | null;
  summary: string | null;
  assetCount: number;
  updatedAt: string | null;
  confluence?: string | null; // e.g., "2/3 bullish", "3/3 bearish", "mixed"
}

const { category, bias, summary, assetCount, updatedAt, confluence } = Astro.props;

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

// Calculate confidence from confluence string
function getConfidenceBadge(confluence: string | null): { labelKey: string; color: string } | null {
  if (!confluence) return null;
  const lower = confluence.toLowerCase();
  if (lower.includes("3/3")) {
    return { labelKey: "signalCard.highConfidence", color: "text-bullish" };
  }
  if (lower.includes("2/3")) {
    return { labelKey: "signalCard.moderate", color: "text-cyber" };
  }
  if (lower === "mixed") {
    return { labelKey: "signalCard.mixedSignals", color: "text-mixed" };
  }
  return null;
}

const confidenceBadge = getConfidenceBadge(confluence);

const categoryConfig: Record<string, { labelKey: string; assetsKey: string; icon: string; gradient: string }> = {
  crypto: {
    labelKey: "signalCard.crypto",
    assetsKey: "signalCard.cryptoAssets",
    icon: "₿",
    gradient: "from-amber-500/20 to-amber-600/5",
  },
  forex: {
    labelKey: "signalCard.forex",
    assetsKey: "signalCard.forexAssets",
    icon: "$",
    gradient: "from-emerald-500/20 to-emerald-600/5",
  },
  stocks: {
    labelKey: "signalCard.stocks",
    assetsKey: "signalCard.stocksAssets",
    icon: "◊",
    gradient: "from-violet-500/20 to-violet-600/5",
  },
};

const config = categoryConfig[category];

function getBiasClass(bias: string | null): string {
  if (!bias) return "bias-neutral";
  const lower = bias.toLowerCase();
  if (lower.includes("bullish")) return "bias-bullish";
  if (lower.includes("bearish")) return "bias-bearish";
  return "bias-neutral";
}

function getBiasIcon(bias: string | null): string {
  if (!bias) return "—";
  const lower = bias.toLowerCase();
  if (lower.includes("bullish")) return "↗";
  if (lower.includes("bearish")) return "↘";
  return "→";
}

function formatTime(isoString: string | null): string {
  if (!isoString) return "--:--";
  try {
    return formatTimeI18n(isoString, locale, { hour: "2-digit", minute: "2-digit", timeZone: "UTC" }) + " UTC";
  } catch {
    return "--:--";
  }
}

// Translate category name for the awaiting message
const categoryDisplayName = t(`category.${category}`);
---

<a href={l(`/${category}`, locale)} class="signal-card group block" data-animate>
  <!-- Gradient overlay for category identity -->
  <div class:list={["absolute inset-0 bg-gradient-to-br rounded-xl opacity-50 group-hover:opacity-70 transition-opacity", config.gradient]}></div>

  <div class="relative flex flex-col h-full min-h-[200px]">
    <!-- Header -->
    <div class="flex items-start justify-between mb-4">
      <div>
        <div class="flex items-center gap-2 mb-1">
          <span class="font-mono text-2xl opacity-40">{config.icon}</span>
          <span class="font-mono text-xs text-txt-muted uppercase tracking-widest">{t(config.labelKey)}</span>
        </div>
        <span class="text-xs text-txt-muted">{t(config.assetsKey)}</span>
      </div>
      <span class:list={[getBiasClass(bias)]}>
        {translateBias(bias, t)}
        <span class="text-lg">{getBiasIcon(bias)}</span>
      </span>
    </div>

    <!-- Summary -->
    <p class="text-sm text-txt-secondary leading-relaxed flex-grow line-clamp-3 mb-4">
      {summary || t("signalCard.awaiting", { category: categoryDisplayName })}
    </p>

    <!-- Footer -->
    <div class="flex items-center justify-between pt-4 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-3">
        <div class="flex items-center gap-1.5 text-xs text-txt-muted">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          {formatTime(updatedAt)}
        </div>
        {confidenceBadge && (
          <span class:list={["text-[10px] font-medium", confidenceBadge.color]}>
            {t(confidenceBadge.labelKey)}
          </span>
        )}
      </div>
      <span class="flex items-center gap-1.5 text-sm font-display font-medium text-cyber group-hover:gap-2.5 transition-all">
        {t("signalCard.viewDetails")}
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
        </svg>
      </span>
    </div>
  </div>
</a>
