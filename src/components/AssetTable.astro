---
// src/components/AssetTable.astro
import BiasIndicator from "./BiasIndicator.astro";

interface Asset {
  id: number;
  ticker: string;
  bias: string | null;
  price: number | null;
  vs_20d_ma: string | null;
  secondary_ind: string | null;
  data_json: string | null;
}

interface OutlierInfo {
  ticker: string;
  field: string;
  value: number;
  reason: string;
}

interface QualityFlags {
  missing_assets?: string[];
  macro_fallback?: boolean;
  macro_stale?: boolean;
  stale_assets?: string[];
  outlier_values?: OutlierInfo[];
}

interface IndicatorData {
  maCrossover?: "bullish" | "bearish" | "neutral";
  indicators?: {
    trend: "bullish" | "bearish" | "neutral";
    momentum: "bullish" | "bearish" | "neutral";
    strength: "bullish" | "bearish" | "neutral";
  };
  confluence?: string;
}

interface Props {
  assets: Asset[];
  category: "crypto" | "forex" | "stocks";
  qualityFlags?: QualityFlags | null;
}

const { assets, category, qualityFlags } = Astro.props;

const secondaryLabel: Record<string, string> = {
  crypto: "Funding",
  forex: "RSI(14)",
  stocks: "RSI(14)",
};

// Parse data_json to get indicator data
function parseIndicatorData(dataJson: string | null): IndicatorData {
  if (!dataJson) return {};
  try {
    return JSON.parse(dataJson) as IndicatorData;
  } catch {
    return {};
  }
}

// Build lookup for stale and outlier assets
const staleSet = new Set(qualityFlags?.stale_assets || []);
const outlierMap = new Map<string, OutlierInfo[]>();
for (const outlier of qualityFlags?.outlier_values || []) {
  const existing = outlierMap.get(outlier.ticker) || [];
  existing.push(outlier);
  outlierMap.set(outlier.ticker, existing);
}

function getAssetStatus(ticker: string): { isStale: boolean; outliers: OutlierInfo[] } {
  return {
    isStale: staleSet.has(ticker),
    outliers: outlierMap.get(ticker) || [],
  };
}

function formatPrice(price: number | null, cat: string): string {
  if (price === null) return "--";
  if (cat === "forex") return price.toFixed(4);
  if (price > 1000) return price.toLocaleString("en-US", { maximumFractionDigits: 0 });
  return price.toLocaleString("en-US", { maximumFractionDigits: 2 });
}

function formatSecondary(value: string | null, cat: string): string {
  if (value === null) return "--";
  if (cat === "crypto") {
    const trimmed = value.trim();
    if (trimmed.endsWith("%")) return trimmed;
    const num = parseFloat(trimmed);
    if (!Number.isFinite(num)) return value;
    return (num * 100).toFixed(4) + "%";
  }
  return value;
}

function getMaClass(value: string | null): string {
  if (value === "above") return "text-bullish bg-bullish/10 border-bullish/20";
  if (value === "below") return "text-bearish bg-bearish/10 border-bearish/20";
  return "text-txt-muted bg-void-100/50 border-void-200/30";
}

function getCrossoverClass(value: string | null | undefined): string {
  if (value === "bullish") return "text-bullish bg-bullish/10 border-bullish/20";
  if (value === "bearish") return "text-bearish bg-bearish/10 border-bearish/20";
  return "text-txt-muted bg-void-100/50 border-void-200/30";
}

function formatCrossover(value: string | null | undefined): string {
  if (value === "bullish") return "↑";
  if (value === "bearish") return "↓";
  return "—";
}

function getAssetUrl(ticker: string, cat: string): string {
  // For forex, use "pair" param; for others use "ticker"
  return `/${cat}/${ticker.toLowerCase()}`;
}
---

<div class="overflow-x-auto -mx-5 px-5">
  <table class="data-table">
    <thead>
      <tr>
        <th>Ticker</th>
        <th>Price</th>
        <th>vs MA20</th>
        <th title="MA10 vs MA20 crossover">MA X</th>
        <th>{secondaryLabel[category]}</th>
        <th>Bias</th>
      </tr>
    </thead>
    <tbody>
      {assets.map((asset) => {
        const status = getAssetStatus(asset.ticker);
        const hasIssue = status.isStale || status.outliers.length > 0;
        const indicatorData = parseIndicatorData(asset.data_json);

        return (
          <tr class:list={[hasIssue && "bg-mixed/5"]}>
            <td>
              <div class="flex items-center gap-1.5">
                <a href={getAssetUrl(asset.ticker, category)} class="font-mono font-semibold text-txt-primary hover:text-cyber transition-colors">
                  {asset.ticker}
                </a>
                {status.isStale && (
                  <span class="inline-flex items-center text-mixed" title="Stale data">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </span>
                )}
                {status.outliers.length > 0 && (
                  <span class="inline-flex items-center text-mixed" title={status.outliers.map(o => o.reason).join("; ")}>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                  </span>
                )}
              </div>
            </td>
            <td>
              <span class="font-mono text-txt-secondary">{formatPrice(asset.price, category)}</span>
            </td>
            <td>
              <span class:list={[
                "inline-flex px-2 py-0.5 rounded text-xs font-medium border",
                getMaClass(asset.vs_20d_ma)
              ]}>
                {asset.vs_20d_ma || "--"}
              </span>
            </td>
            <td>
              <span
                class:list={[
                  "inline-flex px-2 py-0.5 rounded text-xs font-medium border",
                  getCrossoverClass(indicatorData.maCrossover)
                ]}
                title={indicatorData.maCrossover ? `MA10 vs MA20: ${indicatorData.maCrossover}` : "MA crossover"}
              >
                {formatCrossover(indicatorData.maCrossover)}
              </span>
            </td>
            <td>
              <span class="font-mono text-sm text-txt-secondary">{formatSecondary(asset.secondary_ind, category)}</span>
            </td>
            <td>
              <BiasIndicator bias={asset.bias} size="sm" />
            </td>
          </tr>
        );
      })}
    </tbody>
  </table>

  {/* Quality issues legend */}
  {(staleSet.size > 0 || outlierMap.size > 0) && (
    <div class="mt-3 flex flex-wrap gap-4 text-xs text-txt-muted">
      {staleSet.size > 0 && (
        <div class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5 text-mixed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>Stale data</span>
        </div>
      )}
      {outlierMap.size > 0 && (
        <div class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5 text-mixed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>Outlier value</span>
        </div>
      )}
    </div>
  )}
</div>
