---
// src/components/AssetTable.astro
import BiasIndicator from "./BiasIndicator.astro";
import InfoTip from "./InfoTip.astro";
import ScaleBar from "./ScaleBar.astro";
import { formatNumber, type Locale } from "../lib/i18n";

interface Asset {
  id: number;
  ticker: string;
  bias: string | null;
  price: number | null;
  vs_20d_ma: string | null;
  secondary_ind: string | null;
  data_json: string | null;
}

interface OutlierInfo {
  ticker: string;
  field: string;
  value: number;
  reason: string;
}

interface QualityFlags {
  missing_assets?: string[];
  macro_fallback?: boolean;
  macro_stale?: boolean;
  stale_assets?: string[];
  outlier_values?: OutlierInfo[];
}

interface IndicatorData {
  volumeSignal?: "high" | "low" | "normal";
  indicators?: {
    trend: "bullish" | "bearish" | "neutral";
    volume: "confirms" | "diverges" | "neutral";
    strength: "bullish" | "bearish" | "neutral";
  };
  confluence?: string;
}

interface Props {
  assets: Asset[];
  category: "crypto" | "forex" | "stocks";
  qualityFlags?: QualityFlags | null;
  locale?: Locale;
}

const { assets, category, qualityFlags, locale = "en" } = Astro.props;

// Human-readable labels with tooltips for each category
const secondaryConfig: Record<string, { label: string; tooltip: string }> = {
  crypto: {
    label: "Sentiment",
    tooltip: "Fear & Greed Index (0-100). Low = Fear (buy signal), High = Greed (sell signal)"
  },
  forex: {
    label: "Rates",
    tooltip: "Yield curve status. Normal = healthy economy, Inverted = recession warning"
  },
  stocks: {
    label: "Momentum",
    tooltip: "RSI momentum (0-100). Below 30 = oversold, Above 70 = overbought"
  },
};

// Parse data_json to get indicator data
function parseIndicatorData(dataJson: string | null): IndicatorData {
  if (!dataJson) return {};
  try {
    return JSON.parse(dataJson) as IndicatorData;
  } catch {
    return {};
  }
}

// Build lookup for stale and outlier assets
const staleSet = new Set(qualityFlags?.stale_assets || []);
const outlierMap = new Map<string, OutlierInfo[]>();
for (const outlier of qualityFlags?.outlier_values || []) {
  const existing = outlierMap.get(outlier.ticker) || [];
  existing.push(outlier);
  outlierMap.set(outlier.ticker, existing);
}

function getAssetStatus(ticker: string): { isStale: boolean; outliers: OutlierInfo[] } {
  return {
    isStale: staleSet.has(ticker),
    outliers: outlierMap.get(ticker) || [],
  };
}

function formatPrice(price: number | null, cat: string): string {
  if (price === null) return "--";
  if (cat === "forex") return price.toFixed(4);
  if (price > 1000) return formatNumber(price, locale, { maximumFractionDigits: 0 });
  return formatNumber(price, locale, { maximumFractionDigits: 2 });
}

// Extract numeric value from secondary indicator (for scale bar)
function extractNumericValue(value: string | null, cat: string): number | null {
  if (value === null) return null;

  if (cat === "crypto" && value.startsWith("F&G:")) {
    const num = parseInt(value.substring(4), 10);
    return Number.isFinite(num) ? num : null;
  }

  if (cat === "stocks") {
    const num = parseFloat(value);
    return Number.isFinite(num) ? num : null;
  }

  return null;
}

// Format secondary indicator values to be human-readable
function formatSecondary(value: string | null, cat: string): string {
  if (value === null) return "--";

  if (cat === "crypto") {
    // "F&G:24" → "24 (Fear)" or just extract the number
    if (value.startsWith("F&G:")) {
      const num = parseInt(value.substring(4), 10);
      if (Number.isFinite(num)) {
        if (num <= 25) return `${num} (Extreme Fear)`;
        if (num <= 45) return `${num} (Fear)`;
        if (num <= 55) return `${num} (Neutral)`;
        if (num <= 75) return `${num} (Greed)`;
        return `${num} (Extreme Greed)`;
      }
    }
    // Legacy format: funding rate percentage
    const trimmed = value.trim();
    if (trimmed.endsWith("%")) return trimmed;
    const num = parseFloat(trimmed);
    if (!Number.isFinite(num)) return value;
    return (num * 100).toFixed(4) + "%";
  }

  if (cat === "forex") {
    // "YC:normal" → "Normal", "YC:inverted" → "Inverted ⚠️"
    if (value.startsWith("YC:")) {
      const status = value.substring(3);
      if (status === "normal") return "Normal";
      if (status === "inverted") return "Inverted ⚠️";
      if (status === "flat") return "Flat";
      return status;
    }
    return value;
  }

  // Stocks: RSI value - add context
  if (cat === "stocks") {
    const num = parseFloat(value);
    if (Number.isFinite(num)) {
      if (num <= 30) return `${num.toFixed(0)} (Oversold)`;
      if (num >= 70) return `${num.toFixed(0)} (Overbought)`;
      return num.toFixed(0);
    }
  }

  return value;
}

function getMaClass(value: string | null): string {
  if (value === "above") return "text-bullish border ma-above";
  if (value === "below") return "text-bearish border ma-below";
  return "text-txt-muted border ma-neutral";
}

function getVolumeClass(value: string | null | undefined): string {
  if (value === "high") return "text-bullish border vol-high";
  if (value === "low") return "text-mixed border vol-low";
  return "text-txt-muted border vol-neutral";
}

function formatVolume(value: string | null | undefined): string {
  if (value === "high") return "High";
  if (value === "low") return "Low";
  return "Avg";
}

function getAssetUrl(ticker: string, cat: string): string {
  // For forex, use "pair" param; for others use "ticker"
  return `/${cat}/${ticker.toLowerCase()}`;
}
---

<div class="overflow-x-auto -mx-5 px-5">
  <table class="data-table">
    <thead>
      <tr>
        <th>Asset</th>
        <th>Price</th>
        <th>
          <a href="/learn/glossary#ma20" class="inline-flex items-center gap-1 hover:text-cyber transition-colors">
            Trend
            <InfoTip text="Price vs 20-day average. Above = uptrend, Below = downtrend." />
          </a>
        </th>
        <th>
          <a href="/learn/glossary#volume" class="inline-flex items-center gap-1 hover:text-cyber transition-colors">
            Volume
            <InfoTip text="Trading activity vs average. High = strong conviction, Low = weak move." />
          </a>
        </th>
        <th>
          <a href={category === "crypto" ? "/learn/glossary#fear-greed" : category === "stocks" ? "/learn/glossary#rsi" : "/learn/glossary#yield-curve"} class="inline-flex items-center gap-1 hover:text-cyber transition-colors">
            {secondaryConfig[category].label}
            <InfoTip text={secondaryConfig[category].tooltip} />
          </a>
        </th>
        <th>
          <a href="/learn/glossary#bias" class="inline-flex items-center gap-1 hover:text-cyber transition-colors">
            Signal
            <InfoTip text="Bullish = likely to rise, Bearish = likely to fall, Neutral = no clear direction." />
          </a>
        </th>
      </tr>
    </thead>
    <tbody>
      {assets.map((asset) => {
        const status = getAssetStatus(asset.ticker);
        const hasIssue = status.isStale || status.outliers.length > 0;
        const indicatorData = parseIndicatorData(asset.data_json);

        return (
          <tr class:list={[hasIssue && "bg-mixed/5"]}>
            <td>
              <div class="flex items-center gap-1.5">
                <a href={getAssetUrl(asset.ticker, category)} class="font-mono font-semibold text-txt-primary hover:text-cyber transition-colors">
                  {asset.ticker}
                </a>
                {status.isStale && (
                  <span class="inline-flex items-center text-mixed" title="Stale data">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                  </span>
                )}
                {status.outliers.length > 0 && (
                  <span class="inline-flex items-center text-mixed" title={status.outliers.map(o => o.reason).join("; ")}>
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                  </span>
                )}
              </div>
            </td>
            <td>
              <span class="font-mono font-data text-txt-primary">{formatPrice(asset.price, category)}</span>
            </td>
            <td>
              <span
                class:list={[
                  "inline-flex px-2 py-0.5 rounded text-xs font-medium border",
                  getMaClass(asset.vs_20d_ma)
                ]}
                title={asset.vs_20d_ma === "above" ? "Price is above 20-day average (uptrend)" : asset.vs_20d_ma === "below" ? "Price is below 20-day average (downtrend)" : ""}
              >
                {asset.vs_20d_ma === "above" ? "↑ Up" : asset.vs_20d_ma === "below" ? "↓ Down" : "--"}
              </span>
            </td>
            <td>
              <span
                class:list={[
                  "inline-flex px-2 py-0.5 rounded text-xs font-medium border",
                  getVolumeClass(indicatorData.volumeSignal)
                ]}
                title={indicatorData.volumeSignal === "high" ? "Trading volume is higher than average (strong interest)" : indicatorData.volumeSignal === "low" ? "Trading volume is lower than average (weak interest)" : "Trading volume is near average"}
              >
                {formatVolume(indicatorData.volumeSignal)}
              </span>
            </td>
            <td>
              {(() => {
                const numValue = extractNumericValue(asset.secondary_ind, category);
                if (numValue !== null && (category === "crypto" || category === "stocks")) {
                  return (
                    <ScaleBar
                      value={numValue}
                      type={category === "crypto" ? "fear-greed" : "rsi"}
                      compact
                    />
                  );
                }
                return (
                  <span class="font-mono text-sm text-txt-secondary">{formatSecondary(asset.secondary_ind, category)}</span>
                );
              })()}
            </td>
            <td>
              <BiasIndicator bias={asset.bias} size="sm" locale={locale} />
            </td>
          </tr>
        );
      })}
    </tbody>
  </table>

  {/* Quality issues legend */}
  {(staleSet.size > 0 || outlierMap.size > 0) && (
    <div class="mt-3 flex flex-wrap gap-4 text-xs text-txt-muted">
      {staleSet.size > 0 && (
        <div class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5 text-mixed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <span>Stale data</span>
        </div>
      )}
      {outlierMap.size > 0 && (
        <div class="flex items-center gap-1">
          <svg class="w-3.5 h-3.5 text-mixed" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <span>Outlier value</span>
        </div>
      )}
    </div>
  )}
</div>

<style>
  /* Trend indicator badges */
  .ma-above {
    background: var(--bullish-bg);
    border-color: var(--bullish-border);
  }
  .ma-below {
    background: var(--bearish-bg);
    border-color: var(--bearish-border);
  }
  .ma-neutral {
    background: var(--bg-tertiary);
    border-color: var(--border-default);
  }

  /* Volume indicator badges */
  .vol-high {
    background: var(--bullish-bg);
    border-color: var(--bullish-border);
  }
  .vol-low {
    background: var(--neutral-bg);
    border-color: var(--neutral-border);
  }
  .vol-neutral {
    background: var(--bg-tertiary);
    border-color: var(--border-default);
  }
</style>
