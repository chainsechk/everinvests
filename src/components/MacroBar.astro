---
// src/components/MacroBar.astro
import InfoTip from "./InfoTip.astro";
import ScaleBar from "./ScaleBar.astro";

interface Props {
  overall: string | null;
  dxyBias: string | null;
  vixLevel: string | null;
  yieldsBias: string | null;
  dataJson?: string | null; // Raw macro data JSON with expanded fields
}

const { overall, dxyBias, vixLevel, yieldsBias, dataJson } = Astro.props;

// Regime classification types
interface RegimeClassification {
  classification: "normal" | "event" | "stressed" | "crisis";
  signalDampening: number;
  recommendedAction: "aggressive" | "normal" | "cautious" | "defensive";
  riskLevel: "low" | "moderate" | "high" | "critical";
  phase1_event?: {
    active: boolean;
    events: Array<{
      event: string;
      name: string;
      description: string;
    }>;
    dampening: number;
  };
  phase2_fearGreed?: {
    regime: "extreme_fear" | "fear" | "neutral" | "greed" | "extreme_greed";
    value: number;
    contrarian: boolean;
    confidence: number;
  };
  phase3_vix?: {
    regime: "apathy" | "complacent" | "normal" | "stressed" | "crisis";
    vixValue: number;
    action: "aggressive" | "normal" | "cautious" | "defensive";
    signalDampening: number;
  };
  phase4_gdelt?: {
    score: number;
    trend: "rising" | "stable" | "falling";
    topThreats: string[];
    regime: "calm" | "elevated" | "high" | "critical";
    signalDampening: number;
  };
  upcomingEvents?: string[];
  summary: string;
}

// Parse expanded macro data from data_json
interface ExpandedMacroData {
  fearGreed?: number;
  fearGreedLabel?: string;
  btcDominance?: number;
  goldPrice?: number;
  goldChange?: number;
  yieldSpread?: number;
  regime?: RegimeClassification;
}

let expanded: ExpandedMacroData = {};
if (dataJson) {
  try {
    const parsed = JSON.parse(dataJson);
    expanded = {
      fearGreed: parsed.fearGreed,
      fearGreedLabel: parsed.fearGreedLabel,
      btcDominance: parsed.btcDominance,
      goldPrice: parsed.goldPrice,
      goldChange: parsed.goldChange,
      yieldSpread: parsed.yieldSpread,
      regime: parsed.regime,
    };
  } catch {
    // Ignore parse errors
  }
}

// Regime display helpers
function getRegimeColor(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "text-bearish";
    case "stressed": return "text-mixed";
    case "event": return "text-accent";
    default: return "text-bullish";
  }
}

function getRegimeLabel(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "Crisis";
    case "stressed": return "Stressed";
    case "event": return "Event";
    default: return "Normal";
  }
}

function getRegimeIcon(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "!";
    case "stressed": return "â–³";
    case "event": return "â—‰";
    default: return "â—‹";
  }
}

// Phase 2: Fear & Greed regime helpers
function getFearGreedRegimeLabel(regime: string | undefined): string {
  switch (regime) {
    case "extreme_fear": return "Extreme Fear";
    case "fear": return "Fear";
    case "extreme_greed": return "Extreme Greed";
    case "greed": return "Greed";
    default: return "Neutral";
  }
}

function getContrarianSignal(phase2: RegimeClassification["phase2_fearGreed"]): { label: string; color: string } | null {
  if (!phase2?.contrarian) return null;
  if (phase2.regime === "extreme_fear") {
    return { label: "Contrarian Bullish", color: "text-bullish" };
  }
  if (phase2.regime === "extreme_greed") {
    return { label: "Contrarian Bearish", color: "text-bearish" };
  }
  return null;
}

// Phase 3: VIX regime helpers
function getVixRegimeAlert(phase3: RegimeClassification["phase3_vix"]): { label: string; description: string; color: string; icon: string } | null {
  if (!phase3) return null;
  switch (phase3.regime) {
    case "crisis":
      return {
        label: "VIX Crisis",
        description: `VIX at ${phase3.vixValue.toFixed(1)} - defensive positioning recommended`,
        color: "text-bearish",
        icon: "âš "
      };
    case "stressed":
      return {
        label: "Elevated Volatility",
        description: `VIX at ${phase3.vixValue.toFixed(1)} - exercise caution`,
        color: "text-mixed",
        icon: "â–³"
      };
    case "apathy":
      return {
        label: "VIX Complacency Warning",
        description: `VIX at ${phase3.vixValue.toFixed(1)} - unusually low, potential reversal ahead`,
        color: "text-mixed",
        icon: "â—‡"
      };
    default:
      return null; // normal/complacent - no alert needed
  }
}

// Phase 4: GDELT geopolitical regime helpers
function getGdeltRegimeAlert(phase4: RegimeClassification["phase4_gdelt"]): { label: string; description: string; color: string; icon: string } | null {
  if (!phase4) return null;
  switch (phase4.regime) {
    case "critical":
      return {
        label: "Geopolitical Crisis",
        description: `Tension score ${phase4.score} - ${phase4.topThreats.slice(0, 2).join(", ") || "major events"}`,
        color: "text-bearish",
        icon: "âš "
      };
    case "high":
      return {
        label: "High Geopolitical Risk",
        description: `Tension score ${phase4.score}${phase4.trend === "rising" ? " (rising)" : ""}`,
        color: "text-mixed",
        icon: "â–³"
      };
    case "elevated":
      // Only show if trend is rising
      if (phase4.trend === "rising") {
        return {
          label: "Rising Geopolitical Tension",
          description: `Tension score ${phase4.score} - monitoring ${phase4.topThreats[0] || "developments"}`,
          color: "text-mixed",
          icon: "â—‡"
        };
      }
      return null;
    default:
      return null; // calm - no alert needed
  }
}

function getOverallColor(value: string | null): string {
  if (!value) return "text-txt-muted";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "text-bullish";
  if (lower.includes("risk-off")) return "text-bearish";
  return "text-mixed";
}

function getOverallGlow(value: string | null): string {
  if (!value) return "";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "glow-bullish";
  if (lower.includes("risk-off")) return "glow-bearish";
  return "";
}

function formatDxy(bias: string | null): { label: string; icon: string } {
  if (!bias) return { label: "--", icon: "~" };
  const lower = bias.toLowerCase();
  if (lower === "bullish" || lower === "above") return { label: "Strong", icon: "^" };
  if (lower === "bearish" || lower === "below") return { label: "Weak", icon: "v" };
  return { label: "Neutral", icon: "~" };
}

function formatVix(level: string | null): { label: string; color: string } {
  if (!level) return { label: "--", color: "text-txt-muted" };
  const lower = level.toLowerCase();
  if (lower === "risk_on" || lower === "low") return { label: "Low", color: "text-bullish" };
  if (lower === "risk_off" || lower === "high") return { label: "High", color: "text-bearish" };
  return { label: "Moderate", color: "text-mixed" };
}

function formatYields(bias: string | null): { label: string; icon: string } {
  if (!bias) return { label: "--", icon: "~" };
  if (bias === "falling") return { label: "Falling", icon: "v" };
  if (bias === "rising") return { label: "Rising", icon: "^" };
  return { label: "Stable", icon: "~" };
}

function formatFearGreed(value: number | undefined): { label: string; color: string } {
  if (value === undefined) return { label: "--", color: "text-txt-muted" };
  // More descriptive labels that explain what the number means
  if (value <= 25) return { label: `${value} (Extreme Fear)`, color: "text-bearish" };
  if (value <= 45) return { label: `${value} (Fear)`, color: "text-mixed" };
  if (value <= 55) return { label: `${value} (Neutral)`, color: "text-txt-primary" };
  if (value <= 75) return { label: `${value} (Greed)`, color: "text-mixed" };
  return { label: `${value} (Extreme Greed)`, color: "text-bullish" };
}

function formatSpread(value: number | undefined): { label: string; color: string } {
  if (value === undefined) return { label: "--", color: "text-txt-muted" };
  const isInverted = value < 0;
  const label = `${value > 0 ? "+" : ""}${value.toFixed(2)}%`;
  const color = isInverted ? "text-bearish" : "text-bullish";
  return { label, color };
}

const dxy = formatDxy(dxyBias);
const vix = formatVix(vixLevel);
const yields = formatYields(yieldsBias);
const fearGreed = formatFearGreed(expanded.fearGreed);
const spread = formatSpread(expanded.yieldSpread);
const hasExpanded = expanded.fearGreed !== undefined || expanded.yieldSpread !== undefined;
---

<div class="card-glass" data-animate>
  <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-0">
    <!-- Overall Macro Sentiment -->
    <div class="flex items-center gap-3 sm:pr-6 sm:border-r" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2">
        <span class:list={[
          "pulse-dot",
          overall?.toLowerCase().includes("risk-on") ? "pulse-dot-bullish" :
          overall?.toLowerCase().includes("risk-off") ? "pulse-dot-bearish" : "pulse-dot-mixed"
        ]}></span>
        <span class="font-mono text-xs text-txt-muted uppercase tracking-wider inline-flex items-center gap-1">
          Market
          <InfoTip
            text={overall?.toLowerCase().includes("risk-on")
              ? "Risk-On: Markets favor growth assets (stocks, crypto). Generally a good environment for higher-risk investments."
              : overall?.toLowerCase().includes("risk-off")
              ? "Risk-Off: Investors prefer safety (bonds, gold, cash). Caution advised for risky assets."
              : "Mixed signals from the market. Consider smaller positions or wait for clearer direction."}
            position="top"
          />
        </span>
      </div>
      <span class:list={[
        "font-display font-bold text-lg tracking-tight",
        getOverallColor(overall)
      ]}>
        {overall || "Loading..."}
      </span>
    </div>

    <!-- Indicators Grid - human-readable labels with info tips -->
    <div class="flex items-center gap-4 sm:gap-6 sm:pl-6 flex-wrap justify-center">
      <!-- US Dollar Index -->
      <div class="macro-chip">
        <span class="text-txt-muted inline-flex items-center gap-1">
          USD
          <InfoTip text="US Dollar strength. When the dollar is Strong, it typically hurts assets priced in USD (like crypto and commodities). Weak dollar often means risk-on." position="top" />
        </span>
        <span class="text-txt-primary font-semibold">{dxy.label}</span>
        <span class="font-mono text-cyber">{dxy.icon}</span>
      </div>

      <!-- Market Volatility -->
      <div class="macro-chip">
        <span class="text-txt-muted inline-flex items-center gap-1">
          Volatility
          <InfoTip text="Market fear gauge (VIX). Low volatility = calm markets, good for investing. High volatility = fearful markets, prices may swing wildly." position="top" />
        </span>
        <span class:list={["font-semibold", vix.color]}>{vix.label}</span>
      </div>

      <!-- 10Y Treasury Yield -->
      <div class="macro-chip">
        <span class="text-txt-muted inline-flex items-center gap-1">
          10Y Rate
          <InfoTip text="US Treasury bond yields. Rising rates compete with stocks for investor money. Falling rates are generally bullish for risk assets." position="top" />
        </span>
        <span class="text-txt-primary font-semibold">{yields.label}</span>
        <span class="font-mono text-cyber">{yields.icon}</span>
      </div>

      {/* Fear & Greed - only show if data available, with visual scale */}
      {expanded.fearGreed !== undefined && (
        <div class="macro-chip">
          <span class="text-txt-muted inline-flex items-center gap-1">
            Sentiment
            <InfoTip text="Fear & Greed Index (0-100). When everyone is fearful (low), it may be a buying opportunity. When everyone is greedy (high), prices may be overheated." position="top" />
          </span>
          <ScaleBar value={expanded.fearGreed} type="fear-greed" compact />
        </div>
      )}

      {/* Yield Curve Spread */}
      {expanded.yieldSpread !== undefined && (
        <div class="macro-chip">
          <span class="text-txt-muted inline-flex items-center gap-1">
            Rate Spread
            <InfoTip text="Difference between 10-year and 2-year Treasury yields. When negative (inverted), it historically warns of recession. Positive is normal and healthy." position="top" />
          </span>
          <span class:list={["font-semibold font-mono", spread.color]}>{spread.label}</span>
        </div>
      )}

      {/* Regime Classification - Phase 1 */}
      {expanded.regime && (
        <div class="macro-chip">
          <span class="text-txt-muted inline-flex items-center gap-1">
            Regime
            <InfoTip
              text={expanded.regime.summary || "Market regime classification based on events, sentiment, and volatility."}
              position="top"
            />
          </span>
          <span class:list={["font-semibold", getRegimeColor(expanded.regime.classification)]}>
            {getRegimeLabel(expanded.regime.classification)}
          </span>
          <span class="font-mono text-cyber">{getRegimeIcon(expanded.regime.classification)}</span>
        </div>
      )}
    </div>
  </div>

  {/* Event Window Alert - show when active economic event */}
  {expanded.regime?.phase1_event?.active && (
    <div class="mt-3 pt-3 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-sm">
        <span class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-accent/20 text-accent text-xs font-bold">!</span>
        <span class="text-accent font-medium">
          Active Event: {expanded.regime.phase1_event.events.map(e => e.name).join(", ")}
        </span>
        <span class="text-txt-muted text-xs">
          (signals dampened {Math.round((1 - expanded.regime.signalDampening) * 100)}%)
        </span>
      </div>
    </div>
  )}

  {/* Phase 2: Fear & Greed Contrarian Alert - show when sentiment at extremes */}
  {expanded.regime?.phase2_fearGreed?.contrarian && getContrarianSignal(expanded.regime.phase2_fearGreed) && (
    <div class="mt-3 pt-3 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-sm">
        <span class:list={[
          "inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold",
          expanded.regime.phase2_fearGreed.regime === "extreme_fear" ? "bg-bullish/20 text-bullish" : "bg-bearish/20 text-bearish"
        ]}>
          {expanded.regime.phase2_fearGreed.regime === "extreme_fear" ? "â†‘" : "â†“"}
        </span>
        <span class:list={["font-medium inline-flex items-center gap-1", getContrarianSignal(expanded.regime.phase2_fearGreed)?.color]}>
          {getContrarianSignal(expanded.regime.phase2_fearGreed)?.label}
          <InfoTip
            text={expanded.regime.phase2_fearGreed.regime === "extreme_fear"
              ? "Contrarian signal: When fear is extreme, markets often overreact. Historically, buying during extreme fear has led to better returns."
              : "Contrarian signal: When greed is extreme, markets may be overheated. Historically, this precedes pullbacks."}
            position="top"
          />
        </span>
        <span class="text-txt-muted text-xs inline-flex items-center gap-1">
          Fear & Greed at {expanded.regime.phase2_fearGreed.value}
          <InfoTip
            text="The Fear & Greed Index measures market sentiment from 0 (extreme fear) to 100 (extreme greed). Values below 25 or above 75 often signal turning points."
            position="top"
          />
        </span>
      </div>
    </div>
  )}

  {/* Phase 3: VIX Regime Alert - show when VIX at crisis/stressed/apathy */}
  {expanded.regime?.phase3_vix && getVixRegimeAlert(expanded.regime.phase3_vix) && (
    <div class="mt-3 pt-3 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-sm">
        <span class:list={[
          "inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold",
          expanded.regime.phase3_vix.regime === "crisis" ? "bg-bearish/20 text-bearish" : "bg-mixed/20 text-mixed"
        ]}>
          {getVixRegimeAlert(expanded.regime.phase3_vix)?.icon}
        </span>
        <span class:list={["font-medium", getVixRegimeAlert(expanded.regime.phase3_vix)?.color]}>
          {getVixRegimeAlert(expanded.regime.phase3_vix)?.label}
        </span>
        <span class="text-txt-muted text-xs">
          {getVixRegimeAlert(expanded.regime.phase3_vix)?.description}
        </span>
      </div>
    </div>
  )}

  {/* Phase 4: GDELT Geopolitical Alert - show when geopolitical risk elevated/high/critical */}
  {expanded.regime?.phase4_gdelt && getGdeltRegimeAlert(expanded.regime.phase4_gdelt) && (
    <div class="mt-3 pt-3 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-sm">
        <span class:list={[
          "inline-flex items-center justify-center w-5 h-5 rounded-full text-xs font-bold",
          expanded.regime.phase4_gdelt.regime === "critical" ? "bg-bearish/20 text-bearish" : "bg-mixed/20 text-mixed"
        ]}>
          {getGdeltRegimeAlert(expanded.regime.phase4_gdelt)?.icon}
        </span>
        <span class:list={["font-medium", getGdeltRegimeAlert(expanded.regime.phase4_gdelt)?.color]}>
          {getGdeltRegimeAlert(expanded.regime.phase4_gdelt)?.label}
        </span>
        <span class="text-txt-muted text-xs">
          {getGdeltRegimeAlert(expanded.regime.phase4_gdelt)?.description}
        </span>
      </div>
    </div>
  )}

  {/* Upcoming Events - show next 7 days */}
  {expanded.regime?.upcomingEvents && expanded.regime.upcomingEvents.length > 0 && !expanded.regime.phase1_event?.active && (
    <div class="mt-3 pt-3 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-sm text-txt-muted">
        <span class="font-mono text-xs">ðŸ“…</span>
        <span>Upcoming: {expanded.regime.upcomingEvents.slice(0, 3).join(" | ")}</span>
      </div>
    </div>
  )}
</div>
