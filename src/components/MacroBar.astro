---
// src/components/MacroBar.astro
interface Props {
  overall: string | null;
  dxyBias: string | null;
  vixLevel: string | null;
  yieldsBias: string | null;
  dataJson?: string | null; // Raw macro data JSON with expanded fields
}

const { overall, dxyBias, vixLevel, yieldsBias, dataJson } = Astro.props;

// Parse expanded macro data from data_json
interface ExpandedMacroData {
  fearGreed?: number;
  fearGreedLabel?: string;
  btcDominance?: number;
  goldPrice?: number;
  goldChange?: number;
  yieldSpread?: number;
}

let expanded: ExpandedMacroData = {};
if (dataJson) {
  try {
    const parsed = JSON.parse(dataJson);
    expanded = {
      fearGreed: parsed.fearGreed,
      fearGreedLabel: parsed.fearGreedLabel,
      btcDominance: parsed.btcDominance,
      goldPrice: parsed.goldPrice,
      goldChange: parsed.goldChange,
      yieldSpread: parsed.yieldSpread,
    };
  } catch {
    // Ignore parse errors
  }
}

function getOverallColor(value: string | null): string {
  if (!value) return "text-txt-muted";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "text-bullish";
  if (lower.includes("risk-off")) return "text-bearish";
  return "text-mixed";
}

function getOverallGlow(value: string | null): string {
  if (!value) return "";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "glow-bullish";
  if (lower.includes("risk-off")) return "glow-bearish";
  return "";
}

function formatDxy(bias: string | null): { label: string; icon: string } {
  if (!bias) return { label: "--", icon: "~" };
  const lower = bias.toLowerCase();
  if (lower === "bullish" || lower === "above") return { label: "Strong", icon: "^" };
  if (lower === "bearish" || lower === "below") return { label: "Weak", icon: "v" };
  return { label: "Neutral", icon: "~" };
}

function formatVix(level: string | null): { label: string; color: string } {
  if (!level) return { label: "--", color: "text-txt-muted" };
  const lower = level.toLowerCase();
  if (lower === "risk_on" || lower === "low") return { label: "Low", color: "text-bullish" };
  if (lower === "risk_off" || lower === "high") return { label: "High", color: "text-bearish" };
  return { label: "Moderate", color: "text-mixed" };
}

function formatYields(bias: string | null): { label: string; icon: string } {
  if (!bias) return { label: "--", icon: "~" };
  if (bias === "falling") return { label: "Falling", icon: "v" };
  if (bias === "rising") return { label: "Rising", icon: "^" };
  return { label: "Stable", icon: "~" };
}

function formatFearGreed(value: number | undefined): { label: string; color: string } {
  if (value === undefined) return { label: "--", color: "text-txt-muted" };
  if (value <= 25) return { label: `${value} Fear`, color: "text-bearish" };
  if (value <= 45) return { label: `${value}`, color: "text-mixed" };
  if (value <= 55) return { label: `${value}`, color: "text-txt-primary" };
  if (value <= 75) return { label: `${value}`, color: "text-mixed" };
  return { label: `${value} Greed`, color: "text-bullish" };
}

function formatSpread(value: number | undefined): { label: string; color: string } {
  if (value === undefined) return { label: "--", color: "text-txt-muted" };
  const isInverted = value < 0;
  const label = `${value > 0 ? "+" : ""}${value.toFixed(2)}%`;
  const color = isInverted ? "text-bearish" : "text-bullish";
  return { label, color };
}

const dxy = formatDxy(dxyBias);
const vix = formatVix(vixLevel);
const yields = formatYields(yieldsBias);
const fearGreed = formatFearGreed(expanded.fearGreed);
const spread = formatSpread(expanded.yieldSpread);
const hasExpanded = expanded.fearGreed !== undefined || expanded.yieldSpread !== undefined;
---

<div class="card-glass" data-animate>
  <div class="flex flex-col sm:flex-row items-center gap-4 sm:gap-0">
    <!-- Overall Macro Sentiment -->
    <div class="flex items-center gap-3 sm:pr-6 sm:border-r border-void-200/30">
      <div class="flex items-center gap-2">
        <span class="pulse-dot"></span>
        <span class="font-mono text-xs text-txt-muted uppercase tracking-wider">Macro</span>
      </div>
      <span class:list={[
        "font-display font-bold text-lg tracking-tight",
        getOverallColor(overall)
      ]}>
        {overall || "Loading..."}
      </span>
    </div>

    <!-- Indicators Grid -->
    <div class="flex items-center gap-4 sm:gap-6 sm:pl-6 flex-wrap justify-center">
      <!-- DXY -->
      <div class="macro-chip">
        <span class="text-txt-muted">DXY</span>
        <span class="text-txt-primary font-medium">{dxy.label}</span>
        <span class="font-mono text-cyber">{dxy.icon}</span>
      </div>

      <!-- VIX -->
      <div class="macro-chip">
        <span class="text-txt-muted">VIX</span>
        <span class:list={["font-medium", vix.color]}>{vix.label}</span>
      </div>

      <!-- Yields -->
      <div class="macro-chip">
        <span class="text-txt-muted">10Y</span>
        <span class="text-txt-primary font-medium">{yields.label}</span>
        <span class="font-mono text-cyber">{yields.icon}</span>
      </div>

      {/* Expanded indicators - only show if data available */}
      {expanded.fearGreed !== undefined && (
        <div class="macro-chip">
          <span class="text-txt-muted">F&G</span>
          <span class:list={["font-medium", fearGreed.color]}>{fearGreed.label}</span>
        </div>
      )}

      {expanded.yieldSpread !== undefined && (
        <div class="macro-chip">
          <span class="text-txt-muted">2Y-10Y</span>
          <span class:list={["font-medium font-mono", spread.color]}>{spread.label}</span>
        </div>
      )}
    </div>
  </div>
</div>
