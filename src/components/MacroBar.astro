---
// src/components/MacroBar.astro
import InfoTip from "./InfoTip.astro";
import ScaleBar from "./ScaleBar.astro";
import { getLocaleFromUrl, useTranslations } from "../lib/i18n";

const locale = getLocaleFromUrl(Astro.url);
const t = useTranslations(locale);

interface Props {
  overall: string | null;
  dxyBias: string | null;
  vixLevel: string | null;
  yieldsBias: string | null;
  dataJson?: string | null; // Raw macro data JSON with expanded fields
}

const { overall, dxyBias, vixLevel, yieldsBias, dataJson } = Astro.props;

// Regime classification types
interface RegimeClassification {
  classification: "normal" | "event" | "stressed" | "crisis";
  signalDampening: number;
  recommendedAction: "aggressive" | "normal" | "cautious" | "defensive";
  riskLevel: "low" | "moderate" | "high" | "critical";
  phase1_event?: {
    active: boolean;
    events: Array<{
      event: string;
      name: string;
      description: string;
    }>;
    dampening: number;
  };
  phase2_fearGreed?: {
    regime: "extreme_fear" | "fear" | "neutral" | "greed" | "extreme_greed";
    value: number;
    contrarian: boolean;
    confidence: number;
  };
  phase3_vix?: {
    regime: "apathy" | "complacent" | "normal" | "stressed" | "crisis";
    vixValue: number;
    action: "aggressive" | "normal" | "cautious" | "defensive";
    signalDampening: number;
  };
  phase4_gdelt?: {
    score: number;
    trend: "rising" | "stable" | "falling";
    topThreats: string[];
    regime: "calm" | "elevated" | "high" | "critical";
    signalDampening: number;
    lastUpdated?: string;
    // G5 Enhancement fields
    topHeadlines?: Array<{ title: string; url: string }>;
    spikeRatio?: number;
  };
  phase5_polymarket?: {
    regime: "optimistic" | "cautious" | "uncertain" | "pessimistic";
    signalDampening: number;
    cryptoBullish: number;
    fedDovish: number;
    recessionOdds: number;
    avgVolatility: number;
    topMarkets: Array<{
      question: string;
      probability: number;
      category: "crypto" | "fed" | "economy" | "geopolitical";
      volume: number;
    }>;
    lastUpdated: string;
  };
  upcomingEvents?: string[];
  summary: string;
}

// Parse expanded macro data from data_json
interface ExpandedMacroData {
  fearGreed?: number;
  fearGreedLabel?: string;
  btcDominance?: number;
  goldPrice?: number;
  goldChange?: number;
  yieldSpread?: number;
  regime?: RegimeClassification;
}

let expanded: ExpandedMacroData = {};
if (dataJson) {
  try {
    const parsed = JSON.parse(dataJson);
    expanded = {
      fearGreed: parsed.fearGreed,
      fearGreedLabel: parsed.fearGreedLabel,
      btcDominance: parsed.btcDominance,
      goldPrice: parsed.goldPrice,
      goldChange: parsed.goldChange,
      yieldSpread: parsed.yieldSpread,
      regime: parsed.regime,
    };
  } catch {
    // Ignore parse errors
  }
}

// Regime display helpers
function getRegimeColor(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "text-bearish";
    case "stressed": return "text-mixed";
    case "event": return "text-accent";
    default: return "text-bullish";
  }
}

function getRegimeLabelKey(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "regime.crisis";
    case "stressed": return "regime.stressed";
    case "event": return "regime.event";
    default: return "regime.normal";
  }
}

function getRegimeIcon(classification: string | undefined): string {
  switch (classification) {
    case "crisis": return "!";
    case "stressed": return "â–³";
    case "event": return "â—‰";
    default: return "â—‹";
  }
}

// Phase 2: Fear & Greed regime helpers
function getFearGreedRegimeLabelKey(regime: string | undefined): string {
  switch (regime) {
    case "extreme_fear": return "status.extremeFear";
    case "fear": return "status.fear";
    case "extreme_greed": return "status.extremeGreed";
    case "greed": return "status.greed";
    default: return "status.neutral";
  }
}

function getContrarianSignal(phase2: RegimeClassification["phase2_fearGreed"]): { labelKey: string; color: string } | null {
  if (!phase2?.contrarian) return null;
  if (phase2.regime === "extreme_fear") {
    return { labelKey: "alert.contrarianBullish", color: "text-bullish" };
  }
  if (phase2.regime === "extreme_greed") {
    return { labelKey: "alert.contrarianBearish", color: "text-bearish" };
  }
  return null;
}

// Phase 3: VIX regime helpers
function getVixRegimeAlert(phase3: RegimeClassification["phase3_vix"]): { labelKey: string; descriptionKey: string; color: string; icon: string; vixValue: number } | null {
  if (!phase3) return null;
  switch (phase3.regime) {
    case "crisis":
      return {
        labelKey: "alert.vixCrisis",
        descriptionKey: "alert.defensivePositioning",
        color: "text-bearish",
        icon: "âš ",
        vixValue: phase3.vixValue
      };
    case "stressed":
      return {
        labelKey: "alert.elevatedVolatility",
        descriptionKey: "alert.exerciseCaution",
        color: "text-mixed",
        icon: "â–³",
        vixValue: phase3.vixValue
      };
    case "apathy":
      return {
        labelKey: "alert.vixComplacency",
        descriptionKey: "alert.potentialReversal",
        color: "text-mixed",
        icon: "â—‡",
        vixValue: phase3.vixValue
      };
    default:
      return null; // normal/complacent - no alert needed
  }
}

// Phase 4: GDELT geopolitical regime helpers
function getGdeltRegimeAlert(phase4: RegimeClassification["phase4_gdelt"]): { labelKey: string; score: number; topThreats: string[]; trend: string; color: string; icon: string } | null {
  if (!phase4) return null;
  switch (phase4.regime) {
    case "critical":
      return {
        labelKey: "alert.geopoliticalCrisis",
        score: phase4.score,
        topThreats: phase4.topThreats,
        trend: phase4.trend,
        color: "text-bearish",
        icon: "âš "
      };
    case "high":
      return {
        labelKey: "alert.highGeopoliticalRisk",
        score: phase4.score,
        topThreats: phase4.topThreats,
        trend: phase4.trend,
        color: "text-mixed",
        icon: "â–³"
      };
    case "elevated":
      // Only show if trend is rising
      if (phase4.trend === "rising") {
        return {
          labelKey: "alert.risingTension",
          score: phase4.score,
          topThreats: phase4.topThreats,
          trend: phase4.trend,
          color: "text-mixed",
          icon: "â—‡"
        };
      }
      return null;
    default:
      return null; // calm - no alert needed
  }
}

function getOverallColor(value: string | null): string {
  if (!value) return "text-txt-muted";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "text-bullish";
  if (lower.includes("risk-off")) return "text-bearish";
  return "text-mixed";
}

function getOverallGlow(value: string | null): string {
  if (!value) return "";
  const lower = value.toLowerCase();
  if (lower.includes("risk-on")) return "glow-bullish";
  if (lower.includes("risk-off")) return "glow-bearish";
  return "";
}

function formatDxy(bias: string | null): { labelKey: string | null; icon: string } {
  if (!bias) return { labelKey: null, icon: "~" };
  const lower = bias.toLowerCase();
  if (lower === "bullish" || lower === "above") return { labelKey: "status.strong", icon: "^" };
  if (lower === "bearish" || lower === "below") return { labelKey: "status.weak", icon: "v" };
  return { labelKey: "status.neutral", icon: "~" };
}

function formatVix(level: string | null): { labelKey: string | null; color: string } {
  if (!level) return { labelKey: null, color: "text-txt-muted" };
  const lower = level.toLowerCase();
  if (lower === "risk_on" || lower === "low") return { labelKey: "status.low", color: "text-bullish" };
  if (lower === "risk_off" || lower === "high") return { labelKey: "status.high", color: "text-bearish" };
  return { labelKey: "status.moderate", color: "text-mixed" };
}

function formatYields(bias: string | null): { labelKey: string | null; icon: string } {
  if (!bias) return { labelKey: null, icon: "~" };
  if (bias === "falling") return { labelKey: "status.falling", icon: "v" };
  if (bias === "rising") return { labelKey: "status.rising", icon: "^" };
  return { labelKey: "status.stable", icon: "~" };
}

function formatFearGreed(value: number | undefined): { value: number | undefined; labelKey: string | null; color: string } {
  if (value === undefined) return { value: undefined, labelKey: null, color: "text-txt-muted" };
  // More descriptive labels that explain what the number means
  if (value <= 25) return { value, labelKey: "status.extremeFear", color: "text-bearish" };
  if (value <= 45) return { value, labelKey: "status.fear", color: "text-mixed" };
  if (value <= 55) return { value, labelKey: "status.neutral", color: "text-txt-primary" };
  if (value <= 75) return { value, labelKey: "status.greed", color: "text-mixed" };
  return { value, labelKey: "status.extremeGreed", color: "text-bullish" };
}

function formatSpread(value: number | undefined): { label: string; color: string } {
  if (value === undefined) return { label: "--", color: "text-txt-muted" };
  const isInverted = value < 0;
  const label = `${value > 0 ? "+" : ""}${value.toFixed(2)}%`;
  const color = isInverted ? "text-bearish" : "text-bullish";
  return { label, color };
}

// Live News Monitor helpers
function formatTimeAgo(isoString: string | undefined): { key: string; n?: number } {
  if (!isoString) return { key: "status.initializing" };
  try {
    const date = new Date(isoString);
    const now = new Date();
    const diffMs = now.getTime() - date.getTime();
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);

    if (diffMins < 1) return { key: "time.justNow" };
    if (diffMins < 60) return { key: "time.minutesAgo", n: diffMins };
    if (diffHours < 24) return { key: "time.hoursAgo", n: diffHours };
    if (diffDays === 1) return { key: "time.yesterday" };
    return { key: "time.daysAgo", n: diffDays };
  } catch {
    return { key: "time.unknown" };
  }
}

function getMonitorStatus(gdelt: RegimeClassification["phase4_gdelt"]): {
  dot: string;
  dotColor: string;
  labelKey: string;
  score?: number;
  topThreats?: string[];
  trend?: string;
  isRising?: boolean;
} {
  if (!gdelt) {
    return {
      dot: "â—‹",
      dotColor: "text-txt-muted",
      labelKey: "status.initializing"
    };
  }

  switch (gdelt.regime) {
    case "critical":
      return {
        dot: "â—",
        dotColor: "text-bearish",
        labelKey: "status.crisisDetected",
        score: gdelt.score,
        topThreats: gdelt.topThreats
      };
    case "high":
      return {
        dot: "â—",
        dotColor: "text-mixed",
        labelKey: "status.highRisk",
        score: gdelt.score,
        isRising: gdelt.trend === "rising"
      };
    case "elevated":
      return {
        dot: "â—",
        dotColor: "text-accent",
        labelKey: "status.elevatedActivity",
        score: gdelt.score,
        isRising: gdelt.trend === "rising"
      };
    default:
      return {
        dot: "â—",
        dotColor: "text-bullish",
        labelKey: "status.allClear"
      };
  }
}

// Keywords we monitor (for display in calm state)
const MONITORED_KEYWORDS = ["tariffs", "sanctions", "military", "crisis", "trade war"];

// Phase 5: Polymarket prediction market helpers
function getPolymarketRegimeColor(regime: string | undefined): string {
  switch (regime) {
    case "pessimistic": return "text-bearish";
    case "uncertain": return "text-mixed";
    case "cautious": return "text-mixed";
    case "optimistic": return "text-bullish";
    default: return "text-txt-muted";
  }
}

function getPolymarketRegimeLabelKey(regime: string | undefined): string | null {
  switch (regime) {
    case "pessimistic": return "regime.pessimistic";
    case "uncertain": return "regime.uncertain";
    case "cautious": return "regime.cautious";
    case "optimistic": return "regime.optimistic";
    default: return null;
  }
}

function getSentimentColor(value: number, invertForNegative = false): string {
  if (invertForNegative) {
    // Higher = worse (recession odds)
    if (value >= 60) return "text-bearish";
    if (value >= 40) return "text-mixed";
    return "text-bullish";
  }
  // Higher = better (crypto bullish, fed dovish)
  if (value >= 65) return "text-bullish";
  if (value >= 45) return "text-txt-primary";
  return "text-bearish";
}

function formatProbability(value: number): string {
  return `${value}%`;
}

function truncateQuestion(question: string, maxLength = 50): string {
  if (question.length <= maxLength) return question;
  return question.slice(0, maxLength) + "...";
}

const dxy = formatDxy(dxyBias);
const vix = formatVix(vixLevel);
const yields = formatYields(yieldsBias);
const fearGreed = formatFearGreed(expanded.fearGreed);
const spread = formatSpread(expanded.yieldSpread);
const hasExpanded = expanded.fearGreed !== undefined || expanded.yieldSpread !== undefined;
---

<div class="card-glass" data-animate>
  <!-- Market Sentiment Header -->
  <div class="flex items-center justify-center gap-3 mb-3">
    <span class:list={[
      "pulse-dot",
      overall?.toLowerCase().includes("risk-on") ? "pulse-dot-bullish" :
      overall?.toLowerCase().includes("risk-off") ? "pulse-dot-bearish" : "pulse-dot-mixed"
    ]}></span>
    <span class="font-mono text-sm text-txt-muted uppercase tracking-wider inline-flex items-center gap-1">
      {t("macro.market")}
      <InfoTip
        text={overall?.toLowerCase().includes("risk-on")
          ? t("tooltip.riskOn")
          : overall?.toLowerCase().includes("risk-off")
          ? t("tooltip.riskOff")
          : t("tooltip.mixed")}
        position="top"
      />
    </span>
    <span class:list={[
      "font-display font-bold text-xl tracking-tight",
      getOverallColor(overall)
    ]}>
      {overall || t("status.loading")}
    </span>
  </div>
  <div class="text-center mb-5">
    <a
      href={overall?.toLowerCase().includes("risk-on") ? "/learn/glossary#risk-on" : overall?.toLowerCase().includes("risk-off") ? "/learn/glossary#risk-off" : "/learn/glossary#macro-context"}
      class="text-xs text-txt-muted hover:text-cyber transition-colors"
    >
      {t("macro.whatDoesMean")}
    </a>
  </div>

  <!-- Indicators Grid: 2 rows x 3 columns, centered -->
  <div class="grid grid-cols-3 gap-4 max-w-xl mx-auto">
    <!-- Row 1 -->
    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.usd")}
        <InfoTip text={t("tooltip.usd")} position="top" />
      </span>
      <span class="macro-chip-value">{dxy.labelKey ? t(dxy.labelKey) : "--"}</span>
    </div>

    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.volatility")}
        <InfoTip text={t("tooltip.volatility")} position="top" />
      </span>
      <span class:list={["macro-chip-value", vix.color]}>{vix.labelKey ? t(vix.labelKey) : "--"}</span>
    </div>

    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.10yRate")}
        <InfoTip text={t("tooltip.10yRate")} position="top" />
      </span>
      <span class="macro-chip-value">{yields.labelKey ? t(yields.labelKey) : "--"}</span>
    </div>

    <!-- Row 2 -->
    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.sentiment")}
        <InfoTip text={t("tooltip.sentiment")} position="top" />
      </span>
      <span class="macro-chip-value">
        {expanded.fearGreed !== undefined ? expanded.fearGreed : "--"}
      </span>
    </div>

    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.spread")}
        <InfoTip text={t("tooltip.spread")} position="top" />
      </span>
      <span class:list={["macro-chip-value", expanded.yieldSpread !== undefined ? spread.color : ""]}>
        {expanded.yieldSpread !== undefined ? spread.label : "--"}
      </span>
    </div>

    <div class="macro-chip">
      <span class="macro-chip-label">
        {t("macro.regime")}
        <InfoTip text={expanded.regime?.summary || t("tooltip.regime")} position="top" />
      </span>
      <span class:list={["macro-chip-value", expanded.regime ? getRegimeColor(expanded.regime.classification) : ""]}>
        {expanded.regime ? t(getRegimeLabelKey(expanded.regime.classification)) : "--"}
      </span>
    </div>
  </div>

  {/* Event Window Alert - show when active economic event */}
  {expanded.regime?.phase1_event?.active && (
    <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-base">
        <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent/20 text-accent text-sm font-bold">!</span>
        <span class="text-accent font-medium">
          {t("alert.activeEvent")} {expanded.regime.phase1_event.events.map(e => e.name).join(", ")}
        </span>
        <span class="text-txt-muted text-sm">
          {t("alert.signalsDampened", { percent: Math.round((1 - expanded.regime.signalDampening) * 100) })}
        </span>
      </div>
    </div>
  )}

  {/* Phase 2: Fear & Greed Contrarian Alert - show when sentiment at extremes */}
  {expanded.regime?.phase2_fearGreed?.contrarian && getContrarianSignal(expanded.regime.phase2_fearGreed) && (
    <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-base">
        <span class:list={[
          "inline-flex items-center justify-center w-6 h-6 rounded-full text-sm font-bold",
          expanded.regime.phase2_fearGreed.regime === "extreme_fear" ? "bg-bullish/20 text-bullish" : "bg-bearish/20 text-bearish"
        ]}>
          {expanded.regime.phase2_fearGreed.regime === "extreme_fear" ? "â†‘" : "â†“"}
        </span>
        <span class:list={["font-medium inline-flex items-center gap-1", getContrarianSignal(expanded.regime.phase2_fearGreed)?.color]}>
          {t(getContrarianSignal(expanded.regime.phase2_fearGreed)?.labelKey || "")}
          <InfoTip
            text={expanded.regime.phase2_fearGreed.regime === "extreme_fear"
              ? t("tooltip.contrarianFear")
              : t("tooltip.contrarianGreed")}
            position="top"
          />
        </span>
        <span class="text-txt-muted text-sm inline-flex items-center gap-1">
          {t("alert.fearGreedAt", { value: expanded.regime.phase2_fearGreed.value })}
          <InfoTip
            text={t("tooltip.fearGreedIndex")}
            position="top"
          />
        </span>
      </div>
    </div>
  )}

  {/* Phase 3: VIX Regime Alert - show when VIX at crisis/stressed/apathy */}
  {expanded.regime?.phase3_vix && getVixRegimeAlert(expanded.regime.phase3_vix) && (() => {
    const vixAlert = getVixRegimeAlert(expanded.regime.phase3_vix);
    return (
      <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
        <div class="flex items-center gap-2 text-base">
          <span class:list={[
            "inline-flex items-center justify-center w-6 h-6 rounded-full text-sm font-bold",
            expanded.regime.phase3_vix.regime === "crisis" ? "bg-bearish/20 text-bearish" : "bg-mixed/20 text-mixed"
          ]}>
            {vixAlert?.icon}
          </span>
          <span class:list={["font-medium", vixAlert?.color]}>
            {t(vixAlert?.labelKey || "")}
          </span>
          <span class="text-txt-muted text-sm">
            {t("alert.vixAt", { value: vixAlert?.vixValue?.toFixed(1) || "" })} {t(vixAlert?.descriptionKey || "")}
          </span>
        </div>
      </div>
    );
  })()}

  {/* Live News Monitor - Always visible real-time geopolitical monitoring */}
  {(() => {
    const gdelt = expanded.regime?.phase4_gdelt;
    const status = getMonitorStatus(gdelt);
    const timeAgoData = formatTimeAgo(gdelt?.lastUpdated);
    const timeAgoStr = timeAgoData.n !== undefined ? t(timeAgoData.key, { n: timeAgoData.n }) : t(timeAgoData.key);
    const isElevated = gdelt && gdelt.regime !== "calm";
    const hasHeadlines = gdelt?.topHeadlines && gdelt.topHeadlines.length > 0;

    // Build description based on status
    let statusDescription = "";
    if (status.labelKey === "status.initializing") {
      statusDescription = t("tooltip.geopoliticalSetup");
    } else if (status.labelKey === "status.allClear") {
      statusDescription = t("tooltip.noGeopoliticalEvents");
    } else if (status.score !== undefined) {
      const scoreText = t("alert.tensionScore", { score: status.score });
      if (status.topThreats && status.topThreats.length > 0) {
        statusDescription = `${scoreText} - ${status.topThreats.slice(0, 2).join(", ")}`;
      } else if (status.isRising) {
        statusDescription = `${scoreText} â†‘`;
      } else {
        statusDescription = scoreText;
      }
    }

    return (
      <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
        {/* Header row */}
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-sm">ðŸ“¡</span>
            <span class="font-mono text-xs text-txt-muted uppercase tracking-wider inline-flex items-center gap-1">
              {t("macro.liveNews")}
              <InfoTip
                text={t("tooltip.liveNews")}
                position="top"
              />
            </span>
          </div>
          <span class="text-xs text-txt-muted flex items-center gap-1">
            {gdelt?.spikeRatio && gdelt.spikeRatio >= 1.5 ? (
              <span class="text-mixed font-medium">{t("alert.spike", { ratio: gdelt.spikeRatio.toFixed(1) })}</span>
            ) : (
              <span>{t("time.updated", { time: timeAgoStr })}</span>
            )}
          </span>
        </div>

        {/* Status row */}
        <div class="flex items-center gap-2 text-base">
          <span class:list={["text-lg", status.dotColor]}>{status.dot}</span>
          <span class:list={["font-medium", status.dotColor]}>{t(status.labelKey)}</span>
          <span class="text-txt-muted text-sm">{statusDescription}</span>
        </div>

        {/* Headlines when elevated+ */}
        {isElevated && hasHeadlines && (
          <div class="mt-3 pl-6 space-y-1">
            <span class="text-txt-muted text-xs uppercase tracking-wider">{t("macro.topStories")}</span>
            <ul class="text-sm space-y-1">
              {gdelt.topHeadlines.slice(0, 3).map((headline) => (
                <li class="truncate">
                  <a
                    href={headline.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="text-txt-secondary hover:text-accent transition-colors"
                    title={headline.title}
                  >
                    â†’ {headline.title.length > 80 ? headline.title.slice(0, 80) + "..." : headline.title}
                  </a>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Monitored keywords when calm */}
        {!isElevated && gdelt && (
          <div class="mt-2 text-xs text-txt-muted">
            {t("macro.watching")} {MONITORED_KEYWORDS.join(", ")}...
          </div>
        )}
      </div>
    );
  })()}

  {/* Phase 5: Prediction Markets - Always visible */}
  {(() => {
    const polymarket = expanded.regime?.phase5_polymarket;
    const hasData = polymarket && polymarket.topMarkets && polymarket.topMarkets.length > 0;
    const timeAgoData = formatTimeAgo(polymarket?.lastUpdated);
    const timeAgoStr = timeAgoData.n !== undefined ? t(timeAgoData.key, { n: timeAgoData.n }) : t(timeAgoData.key);

    return (
      <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
        {/* Header row */}
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            <span class="text-sm">ðŸ”®</span>
            <span class="font-mono text-xs text-txt-muted uppercase tracking-wider inline-flex items-center gap-1">
              {t("macro.predictionMarkets")}
              <InfoTip
                text={t("tooltip.predictionMarkets")}
                position="top"
              />
            </span>
          </div>
          <span class="text-xs text-txt-muted">
            {polymarket ? t("time.updated", { time: timeAgoStr }) : t("status.initializing") + "..."}
          </span>
        </div>

        {/* Sentiment metrics grid */}
        {polymarket && (
          <div class="grid grid-cols-3 gap-3 mb-3">
            <div class="text-center">
              <div class="text-xs text-txt-muted mb-1">{t("macro.crypto")}</div>
              <div class:list={["text-sm font-medium", getSentimentColor(polymarket.cryptoBullish)]}>
                {formatProbability(polymarket.cryptoBullish)} {t("macro.bullish")}
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-txt-muted mb-1">{t("macro.fed")}</div>
              <div class:list={["text-sm font-medium", getSentimentColor(polymarket.fedDovish)]}>
                {formatProbability(polymarket.fedDovish)} {t("macro.dovish")}
              </div>
            </div>
            <div class="text-center">
              <div class="text-xs text-txt-muted mb-1">{t("macro.recession")}</div>
              <div class:list={["text-sm font-medium", getSentimentColor(polymarket.recessionOdds, true)]}>
                {formatProbability(polymarket.recessionOdds)} {t("macro.odds")}
              </div>
            </div>
          </div>
        )}

        {/* Top markets list */}
        {hasData && (
          <div class="space-y-1">
            <span class="text-txt-muted text-xs uppercase tracking-wider">{t("macro.topMarkets")}</span>
            <ul class="text-sm space-y-1">
              {polymarket.topMarkets.slice(0, 3).map((market) => (
                <li class="flex items-center justify-between gap-2">
                  <span class="text-txt-secondary truncate" title={market.question}>
                    {truncateQuestion(market.question)}
                  </span>
                  <span class:list={[
                    "font-medium whitespace-nowrap",
                    market.probability >= 70 ? "text-bullish" :
                    market.probability <= 30 ? "text-bearish" : "text-txt-primary"
                  ]}>
                    {market.probability}%
                  </span>
                </li>
              ))}
            </ul>
          </div>
        )}

        {/* Regime indicator when not optimistic */}
        {polymarket && polymarket.regime !== "optimistic" && (
          <div class="mt-2 flex items-center gap-2 text-xs">
            <span class:list={[getPolymarketRegimeColor(polymarket.regime)]}>
              {polymarket.regime === "pessimistic" ? "âš " : "â–³"}
            </span>
            <span class:list={["font-medium", getPolymarketRegimeColor(polymarket.regime)]}>
              {getPolymarketRegimeLabelKey(polymarket.regime) ? t(getPolymarketRegimeLabelKey(polymarket.regime)!) : "--"}
            </span>
            <span class="text-txt-muted">
              {polymarket.regime === "pessimistic" ? t("alert.highRecessionRisk") :
               polymarket.regime === "uncertain" ? t("alert.marketsHighUncertainty") :
               t("alert.mixedSignals")}
            </span>
          </div>
        )}

        {/* Fallback when no data */}
        {!polymarket && (
          <div class="text-sm text-txt-muted">
            {t("status.loading")}
          </div>
        )}
      </div>
    );
  })()}

  {/* Upcoming Events - show next 7 days */}
  {expanded.regime?.upcomingEvents && expanded.regime.upcomingEvents.length > 0 && !expanded.regime.phase1_event?.active && (
    <div class="mt-4 pt-4 border-t" style="border-color: var(--border-divider);">
      <div class="flex items-center gap-2 text-base text-txt-muted">
        <span class="font-mono text-sm inline-flex items-center gap-1">
          ðŸ“…
          <InfoTip
            text={t("tooltip.upcomingEvents")}
            position="top"
          />
        </span>
        <span>{t("macro.upcoming")} {expanded.regime.upcomingEvents.slice(0, 3).join(" | ")}</span>
      </div>
    </div>
  )}
</div>
