---
// src/components/HistoryList.astro
import BiasIndicator from "./BiasIndicator.astro";
import DeltaBadge from "./DeltaBadge.astro";

interface Signal {
  id: number;
  date: string;
  time_slot: string;
  bias: string;
  macro_overall: string | null;
  output_json: string | null;
}

interface Props {
  signals: Signal[];
  category: "crypto" | "forex" | "stocks";
}

const { signals, category } = Astro.props;

function formatDate(dateStr: string): string {
  try {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", { weekday: "long", year: "numeric", month: "long", day: "numeric" });
  } catch {
    return dateStr;
  }
}

function extractSummary(outputJson: string | null): string | null {
  if (!outputJson) return null;
  try {
    const output = JSON.parse(outputJson);
    return output.summary || null;
  } catch {
    return null;
  }
}

function extractDelta(outputJson: string | null): any | null {
  if (!outputJson) return null;
  try {
    const output = JSON.parse(outputJson);
    return output.delta || null;
  } catch {
    return null;
  }
}

function getMacroColor(macro: string | null): string {
  if (!macro) return "text-txt-muted";
  const lower = macro.toLowerCase();
  if (lower.includes("risk-on")) return "text-bullish";
  if (lower.includes("risk-off")) return "text-bearish";
  return "text-mixed";
}
---

<div class="space-y-4">
  {signals.map((signal, index) => (
    <a
      href={`/${category}/${signal.date}/${signal.time_slot}`}
      class="card block hover:border-cyber/30 transition-all"
      data-animate
      style={`animation-delay: ${index * 50}ms`}
    >
      <div class="flex flex-wrap items-start justify-between gap-4 mb-3">
        <div>
          <div class="font-display font-medium text-txt-primary">{formatDate(signal.date)}</div>
          <div class="text-sm text-txt-muted font-mono">{signal.time_slot} UTC</div>
        </div>
        <div class="flex items-center gap-3">
          {signal.macro_overall && (
            <span class:list={["text-sm font-medium", getMacroColor(signal.macro_overall)]}>
              {signal.macro_overall}
            </span>
          )}
          <BiasIndicator bias={signal.bias} size="md" />
        </div>
      </div>
      {extractSummary(signal.output_json) && (
        <p class="text-sm text-txt-secondary leading-relaxed line-clamp-2">
          {extractSummary(signal.output_json)}
        </p>
      )}
      {extractDelta(signal.output_json) && (
        <div class="mt-2 pt-2 border-t border-divider">
          <DeltaBadge delta={extractDelta(signal.output_json)} variant="compact" />
        </div>
      )}
    </a>
  ))}

  {signals.length === 0 && (
    <div class="card text-center py-16">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-void-100 flex items-center justify-center">
        <svg class="w-8 h-8 text-txt-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
      </div>
      <h3 class="font-display font-semibold text-lg text-txt-primary mb-2">No History Yet</h3>
      <p class="text-txt-muted">Historical signals will appear here as they're generated.</p>
    </div>
  )}
</div>
