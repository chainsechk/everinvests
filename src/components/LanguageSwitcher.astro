---
// src/components/LanguageSwitcher.astro
// Language switcher dropdown for i18n support
import { locales, localeNames, l, getLocaleFromUrl, type Locale, defaultLocale } from "../i18n";

interface Props {
  locale?: Locale;
  compact?: boolean;
}

const { locale: explicitLocale, compact = false } = Astro.props;
const currentLocale = explicitLocale ?? getLocaleFromUrl(Astro.url);

// Get the current path without locale prefix
function getCleanPath(pathname: string): string {
  for (const loc of locales) {
    if (pathname.startsWith(`/${loc}/`)) {
      return pathname.slice(loc.length + 1);
    }
    if (pathname === `/${loc}`) {
      return "/";
    }
  }
  return pathname;
}

const cleanPath = getCleanPath(Astro.url.pathname);

// Generate URLs for each locale
const localeUrls = locales.map((loc) => ({
  locale: loc,
  name: localeNames[loc],
  url: l(cleanPath, loc),
  isCurrent: loc === currentLocale,
}));
---

<div class="language-switcher" data-compact={compact ? "true" : undefined}>
  <button
    class="language-switcher-btn"
    type="button"
    aria-label="Select language"
    aria-haspopup="listbox"
    aria-expanded="false"
  >
    <svg class="globe-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <circle cx="12" cy="12" r="10"/>
      <path d="M2 12h20"/>
      <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
    </svg>
    <span class="current-locale">{localeNames[currentLocale]}</span>
    <svg class="chevron-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="m6 9 6 6 6-6"/>
    </svg>
  </button>

  <ul class="language-dropdown" role="listbox" aria-label="Select language">
    {localeUrls.map(({ locale, name, url, isCurrent }) => (
      <li role="option" aria-selected={isCurrent}>
        <a
          href={url}
          class:list={["language-option", isCurrent && "language-option-active"]}
          data-locale={locale}
        >
          <span class="locale-name">{name}</span>
          {isCurrent && (
            <svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
              <path d="M20 6 9 17l-5-5"/>
            </svg>
          )}
        </a>
      </li>
    ))}
  </ul>
</div>

<script>
  // Language switcher dropdown functionality
  document.querySelectorAll('.language-switcher').forEach((switcher) => {
    const btn = switcher.querySelector('.language-switcher-btn');
    const dropdown = switcher.querySelector('.language-dropdown');

    if (!btn || !dropdown) return;

    // Toggle dropdown
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = btn.getAttribute('aria-expanded') === 'true';
      btn.setAttribute('aria-expanded', (!isOpen).toString());
      dropdown.classList.toggle('open', !isOpen);
    });

    // Close on click outside
    document.addEventListener('click', (e) => {
      if (!switcher.contains(e.target as Node)) {
        btn.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('open');
      }
    });

    // Close on escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        btn.setAttribute('aria-expanded', 'false');
        dropdown.classList.remove('open');
      }
    });

    // Track language change
    dropdown.querySelectorAll('.language-option').forEach((option) => {
      option.addEventListener('click', () => {
        const locale = option.getAttribute('data-locale');
        fetch('/api/track', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            event: 'language_change',
            meta: {
              from: document.documentElement.lang,
              to: locale,
              path: window.location.pathname
            }
          })
        }).catch(() => {});
      });
    });
  });
</script>

<style>
  .language-switcher {
    position: relative;
  }

  .language-switcher-btn {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    border-radius: 8px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-default);
    color: var(--text-secondary);
    font-family: 'Outfit', sans-serif;
    font-size: var(--font-size-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .language-switcher-btn:hover {
    color: var(--text-primary);
    border-color: var(--border-strong);
  }

  .language-switcher-btn:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .globe-icon {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .current-locale {
    max-width: 80px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  /* Compact mode hides the text on smaller screens */
  [data-compact="true"] .current-locale {
    display: none;
  }

  @media (min-width: 640px) {
    [data-compact="true"] .current-locale {
      display: inline;
    }
  }

  .chevron-icon {
    width: 14px;
    height: 14px;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .language-switcher-btn[aria-expanded="true"] .chevron-icon {
    transform: rotate(180deg);
  }

  /* Dropdown */
  .language-dropdown {
    position: absolute;
    top: calc(100% + 4px);
    right: 0;
    min-width: 140px;
    padding: 4px;
    border-radius: 10px;
    background: var(--bg-secondary);
    border: 1px solid var(--border-default);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-8px);
    transition: all 0.2s ease;
    z-index: 100;
    list-style: none;
    margin: 0;
  }

  .language-dropdown.open {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .language-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
    padding: 10px 12px;
    border-radius: 6px;
    color: var(--text-secondary);
    font-size: var(--font-size-sm);
    text-decoration: none;
    transition: all 0.15s ease;
  }

  .language-option:hover {
    color: var(--text-primary);
    background: var(--bg-tertiary);
  }

  .language-option-active {
    color: var(--accent);
    background: var(--accent-surface);
  }

  .language-option-active:hover {
    color: var(--accent);
  }

  .locale-name {
    font-weight: 500;
  }

  .check-icon {
    width: 14px;
    height: 14px;
    color: var(--accent);
  }

  /* RTL support */
  [dir="rtl"] .language-dropdown {
    right: auto;
    left: 0;
  }
</style>
