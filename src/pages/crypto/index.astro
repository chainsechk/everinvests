---
// src/pages/crypto/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import MacroBar from "../../components/MacroBar.astro";
import SignalDetail from "../../components/SignalDetail.astro";
import AssetTable from "../../components/AssetTable.astro";
import HistoryMini from "../../components/HistoryMini.astro";
import TelegramCTA from "../../components/TelegramCTA.astro";
import VIPCTA from "../../components/VIPCTA.astro";
import ApexPreview from "../../components/ApexPreview.astro";
import NextUpdateCountdown from "../../components/NextUpdateCountdown.astro";
import { getLatestMacro, getLatestSignal, getLatestSignalWithAssets, getAssetSignals, getSignalHistory } from "../../lib/db";
import { absoluteUrl } from "../../lib/site";

const category = "crypto" as const;
const categoryTitle = "Crypto";
const categoryDescription = "Free daily BTC & ETH signals with market bias, Fear & Greed index, and macro context. Upgrade to VIP for regime analysis and trade directives.";

const db = Astro.locals.runtime?.env?.DB;

let macro = null;
let signal = null;
let assets: any[] = [];
let history: any[] = [];
let qualityFlags: any = null;
let usingFallbackAssets = false;

if (db) {
  [macro, signal] = await Promise.all([
    getLatestMacro(db),
    getLatestSignal(db, category),
  ]);

  if (signal) {
    [assets, history] = await Promise.all([
      getAssetSignals(db, signal.id),
      getSignalHistory(db, category, 7),
    ]);

    // Parse quality flags from output_json
    if (signal.output_json) {
      try {
        const output = JSON.parse(signal.output_json);
        qualityFlags = output.quality_flags || null;
      } catch {
        // Ignore parse errors
      }
    }

    // Fallback: if current signal has no assets, get assets from last signal with data
    if (assets.length === 0) {
      const fallbackSignal = await getLatestSignalWithAssets(db, category);
      if (fallbackSignal && fallbackSignal.id !== signal.id) {
        assets = await getAssetSignals(db, fallbackSignal.id);
        usingFallbackAssets = true;
      }
    }
  }
}

// Structured data for SEO
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: absoluteUrl("/") },
    { "@type": "ListItem", position: 2, name: "Crypto Signals", item: absoluteUrl("/crypto") },
  ],
};

const serviceSchema = {
  "@context": "https://schema.org",
  "@type": "Service",
  name: "EverInvests Crypto Signals",
  description: "Free daily Bitcoin and Ethereum market signals with bias analysis and macro context",
  provider: { "@type": "Organization", name: "EverInvests" },
  serviceType: "Market Analysis",
  areaServed: "Worldwide",
  offers: {
    "@type": "Offer",
    price: "0",
    priceCurrency: "USD",
    description: "Free daily crypto signals",
  },
};
---

<BaseLayout title={categoryTitle} description={categoryDescription} image="/og/signal/crypto.png" jsonLd={[breadcrumbSchema, serviceSchema]}>
  <Header slot="header" />

  <div class="space-y-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm" data-animate>
      <a href="/" class="text-txt-muted hover:text-txt-primary transition-colors">Home</a>
      <svg class="w-4 h-4 text-txt-muted/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <span class="text-txt-primary font-medium">{categoryTitle}</span>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4" data-animate>
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="text-3xl">â‚¿</span>
          <h1 class="font-display font-bold text-3xl sm:text-4xl text-txt-primary">{categoryTitle} Signals</h1>
        </div>
        <p class="text-txt-secondary">BTC, ETH daily analysis with funding rate insights</p>
      </div>
      <TelegramCTA variant="compact" />
    </div>

    <!-- Next Update Countdown -->
    <NextUpdateCountdown category="crypto" />

    <!-- Macro Context -->
    <MacroBar
      overall={macro?.overall}
      dxyBias={macro?.dxy_bias}
      vixLevel={macro?.vix_level}
      yieldsBias={macro?.yields_bias}
      dataJson={macro?.data_json}
    />

    <!-- Current Signal -->
    {signal ? (
      <SignalDetail signal={signal} />
    ) : (
      <div class="card text-center py-16" data-animate>
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-void-100 flex items-center justify-center">
          <svg class="w-8 h-8 text-txt-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="font-display font-semibold text-lg text-txt-primary mb-2">No Signal Yet</h3>
        <p class="text-txt-muted">Check back at the next scheduled update.</p>
      </div>
    )}

    <!-- Asset Table -->
    {assets.length > 0 && (
      <div class="card" data-animate>
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-display font-semibold text-lg text-txt-primary">Asset Breakdown</h2>
          {usingFallbackAssets && (
            <span class="text-xs text-txt-muted bg-subtle px-2 py-1 rounded">Using last available data</span>
          )}
        </div>
        <AssetTable assets={assets} category={category} qualityFlags={usingFallbackAssets ? null : qualityFlags} />
      </div>
    )}

    <!-- VIP Intelligence Preview -->
    <ApexPreview category="crypto" />

    <!-- VIP CTA -->
    <VIPCTA category="crypto" mode="waitlist" utmSource="crypto_page" />

    <!-- History Mini -->
    <div class="card" data-animate>
      <HistoryMini signals={history} category={category} />
    </div>

    <!-- Learn More Section -->
    <div class="card" data-animate>
      <h2 class="font-display font-semibold text-lg text-txt-primary mb-4">Learn More</h2>
      <div class="grid gap-3 sm:grid-cols-2">
        <a href="/guides/bullish-vs-bearish" class="flex items-start gap-3 p-3 rounded-lg bg-void-200 hover:bg-void-300 transition-colors">
          <span class="text-xl">ðŸ“Š</span>
          <div>
            <div class="font-medium text-txt-primary text-sm">What does Bullish mean?</div>
            <div class="text-xs text-txt-muted">Understanding our signal types</div>
          </div>
        </a>
        <a href="/guides/fear-and-greed" class="flex items-start gap-3 p-3 rounded-lg bg-void-200 hover:bg-void-300 transition-colors">
          <span class="text-xl">ðŸ˜¨</span>
          <div>
            <div class="font-medium text-txt-primary text-sm">Fear & Greed Explained</div>
            <div class="text-xs text-txt-muted">How we use sentiment as a contrarian signal</div>
          </div>
        </a>
        <a href="/learn/methodology" class="flex items-start gap-3 p-3 rounded-lg bg-void-200 hover:bg-void-300 transition-colors">
          <span class="text-xl">ðŸ”¬</span>
          <div>
            <div class="font-medium text-txt-primary text-sm">How We Calculate Signals</div>
            <div class="text-xs text-txt-muted">Our 3-indicator confluence model</div>
          </div>
        </a>
        <a href="/learn/glossary" class="flex items-start gap-3 p-3 rounded-lg bg-void-200 hover:bg-void-300 transition-colors">
          <span class="text-xl">ðŸ“–</span>
          <div>
            <div class="font-medium text-txt-primary text-sm">Trading Glossary</div>
            <div class="text-xs text-txt-muted">Key terms: RSI, confluence, bias, and more</div>
          </div>
        </a>
      </div>
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>
