---
// src/pages/performance.astro
import BaseLayout from "../layouts/BaseLayout.astro";
import Header from "../components/Header.astro";
import Footer from "../components/Footer.astro";
import TelegramCTA from "../components/TelegramCTA.astro";
import VIPCTA from "../components/VIPCTA.astro";

interface AccuracyData {
  category: string;
  period: { days: number; since: string };
  overall: { total: number; correct: number; rate: number | null };
  byBias: Record<string, { total: number; correct: number; rate: number }>;
  recent: Array<{ date: string; bias: string; priceChange: number; correct: boolean }>;
}

interface StatsData {
  totalSignals: number;
  accuracyRate: number | null;
  signalsToday: number;
  last30Days: { byCategory: Record<string, number> };
  generatedAt: string;
}

const db = Astro.locals.runtime?.env?.DB;

let stats: StatsData | null = null;
let cryptoAccuracy: AccuracyData | null = null;
let forexAccuracy: AccuracyData | null = null;
let stocksAccuracy: AccuracyData | null = null;

if (db) {
  const today = new Date().toISOString().split("T")[0];
  const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split("T")[0];

  // NOTE: These are D1 (Cloudflare SQLite) queries - NO rate limits, safe to parallelize.
  // This is different from worker/src/data/*.ts which call external APIs (TwelveData, Alpha Vantage)
  // that ARE rate-limited and MUST remain sequential. Don't confuse the two!
  const [signals, accuracy, signalsToday, categories] = await Promise.all([
    db.prepare("SELECT COUNT(*) as count FROM signals").first<{ count: number }>(),
    db.prepare(`SELECT AVG(correct) * 100 as rate FROM signal_outcomes WHERE checked_at >= ?`).bind(thirtyDaysAgo).first<{ rate: number | null }>(),
    db.prepare("SELECT COUNT(*) as count FROM signals WHERE date = ?").bind(today).first<{ count: number }>(),
    db.prepare(`SELECT category, COUNT(*) as count FROM signals WHERE date >= ? GROUP BY category`).bind(thirtyDaysAgo).all<{ category: string; count: number }>(),
  ]);

  const categoryBreakdown: Record<string, number> = {};
  for (const row of categories.results || []) {
    categoryBreakdown[row.category] = row.count;
  }

  stats = {
    totalSignals: signals?.count ?? 0,
    accuracyRate: accuracy?.rate ? Math.round(accuracy.rate) : null,
    signalsToday: signalsToday?.count ?? 0,
    last30Days: { byCategory: categoryBreakdown },
    generatedAt: new Date().toISOString(),
  };

  // Fetch accuracy per category (parallelized queries)
  const fetchCategoryAccuracy = async (category: string): Promise<AccuracyData | null> => {
    const cutoff = thirtyDaysAgo;

    // Run both queries in parallel
    const [statsQuery, recentQuery] = await Promise.all([
      db
        .prepare(`SELECT predicted_bias, COUNT(*) as total, SUM(correct) as correct FROM signal_outcomes WHERE category = ? AND checked_at >= ? GROUP BY predicted_bias`)
        .bind(category, cutoff)
        .all<{ predicted_bias: string; total: number; correct: number }>(),
      db
        .prepare(`SELECT s.date, o.predicted_bias as bias, o.price_change_pct, o.correct FROM signal_outcomes o JOIN signals s ON o.signal_id = s.id WHERE o.category = ? ORDER BY o.checked_at DESC LIMIT 10`)
        .bind(category)
        .all<{ date: string; bias: string; price_change_pct: number; correct: number }>(),
    ]);

    let total = 0;
    let correct = 0;
    const byBias: Record<string, { total: number; correct: number; rate: number }> = {
      Bullish: { total: 0, correct: 0, rate: 0 },
      Bearish: { total: 0, correct: 0, rate: 0 },
      Neutral: { total: 0, correct: 0, rate: 0 },
    };

    for (const row of statsQuery.results || []) {
      total += row.total;
      correct += row.correct;
      byBias[row.predicted_bias] = {
        total: row.total,
        correct: row.correct,
        rate: row.total > 0 ? Math.round((row.correct / row.total) * 100) : 0,
      };
    }

    return {
      category,
      period: { days: 30, since: cutoff },
      overall: { total, correct, rate: total > 0 ? Math.round((correct / total) * 100) : null },
      byBias,
      recent: (recentQuery.results || []).map((r) => ({
        date: r.date,
        bias: r.bias,
        priceChange: Math.round(r.price_change_pct * 100) / 100,
        correct: r.correct === 1,
      })),
    };
  };

  [cryptoAccuracy, forexAccuracy, stocksAccuracy] = await Promise.all([
    fetchCategoryAccuracy("crypto"),
    fetchCategoryAccuracy("forex"),
    fetchCategoryAccuracy("stocks"),
  ]);
}

const categories = [
  { key: "crypto", label: "Crypto", icon: "₿", data: cryptoAccuracy },
  { key: "forex", label: "Forex", icon: "$", data: forexAccuracy },
  { key: "stocks", label: "Stocks", icon: "◊", data: stocksAccuracy },
];

// Combine all recent outcomes for timeline
const allRecent = categories
  .flatMap(c => (c.data?.recent || []).map(r => ({ ...r, category: c.key, label: c.label })))
  .sort((a, b) => b.date.localeCompare(a.date))
  .slice(0, 15);

// Structured data for SEO
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: "https://everinvests.com" },
    { "@type": "ListItem", position: 2, name: "Performance", item: "https://everinvests.com/performance" },
  ],
};
---

<BaseLayout
  title="Signal Performance"
  description="Track EverInvests signal accuracy across crypto, forex, and stocks. Transparent performance metrics updated daily."
  jsonLd={[breadcrumbSchema]}
>
  <Header slot="header" />

  <div class="space-y-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm" data-animate>
      <a href="/" class="text-txt-muted hover:text-txt-primary transition-colors">Home</a>
      <svg class="w-4 h-4 text-txt-muted/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <span class="text-txt-primary font-medium">Performance</span>
    </nav>

    <!-- Page Header -->
    <div class="text-center py-4" data-animate>
      <h1 class="font-display font-bold text-3xl sm:text-4xl text-txt-primary mb-3">Our Track Record</h1>
      <p class="text-txt-secondary max-w-xl mx-auto">
        Transparent performance metrics. Updated daily.
      </p>
    </div>

    <!-- Heritage Section -->
    <div class="card border-cyber/20" data-animate>
      <div class="flex items-start gap-4">
        <div class="w-12 h-12 rounded-xl bg-cyber/10 flex items-center justify-center shrink-0">
          <svg class="w-6 h-6 text-cyber" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
          </svg>
        </div>
        <div class="flex-1">
          <h2 class="font-display font-semibold text-lg text-txt-primary mb-2">The Numbers</h2>
          <p class="text-sm text-txt-secondary mb-4">
            We traded crypto with real money for 5 years. Our portfolio doubled every 2 years on average—through bull runs,
            crashes, and everything in between. Now we share the same signals for free.
          </p>
          <div class="grid gap-4 sm:grid-cols-3">
            <div class="text-center p-3 rounded-lg bg-subtle">
              <div class="font-mono text-2xl font-bold text-bullish">2x</div>
              <div class="text-xs text-txt-muted">Every 2 Years</div>
              <div class="text-[10px] text-txt-muted/60">Crypto 2019-2024</div>
            </div>
            <div class="text-center p-3 rounded-lg bg-subtle">
              <div class="font-mono text-2xl font-bold text-cyber">5</div>
              <div class="text-xs text-txt-muted">Years Live Trading</div>
              <div class="text-[10px] text-txt-muted/60">Real money, real results</div>
            </div>
            <div class="text-center p-3 rounded-lg bg-subtle">
              <div class="font-mono text-2xl font-bold text-txt-primary">3</div>
              <div class="text-xs text-txt-muted">Checks Per Signal</div>
              <div class="text-[10px] text-txt-muted/60">Price + Volume + Mood</div>
            </div>
          </div>
          <p class="text-[10px] text-txt-muted/60 mt-3">
            *Past performance does not guarantee future results. Always do your own research.
          </p>
        </div>
      </div>
    </div>

    <!-- Overall Stats -->
    {stats && (
      <div class="grid gap-4 sm:grid-cols-3" data-animate>
        <div class="card text-center py-6">
          <div class="font-mono text-4xl font-bold text-cyber mb-2">{stats.totalSignals.toLocaleString()}</div>
          <div class="text-sm text-txt-muted">Total Signals</div>
        </div>
        <div class="card text-center py-6">
          {stats.accuracyRate !== null ? (
            <>
              <div class="font-mono text-4xl font-bold text-txt-primary mb-2">{stats.accuracyRate}%</div>
              <div class="text-sm text-txt-muted">30-Day Accuracy</div>
              <div class="text-xs text-txt-muted/60 mt-1">vs 50% random baseline</div>
            </>
          ) : (
            <>
              <div class="font-mono text-2xl font-bold text-txt-muted mb-2">Building...</div>
              <div class="text-sm text-txt-muted">30-Day Accuracy</div>
              <div class="text-xs text-txt-muted/60 mt-1">Requires 30 days of data</div>
            </>
          )}
        </div>
        <div class="card text-center py-6">
          <div class="font-mono text-4xl font-bold text-txt-secondary mb-2">{stats.signalsToday}</div>
          <div class="text-sm text-txt-muted">Signals Today</div>
        </div>
      </div>
    )}

    <!-- Category Breakdown -->
    <div class="space-y-4" data-animate>
      <h2 class="font-display font-semibold text-xl text-txt-primary">Accuracy by Category</h2>
      <div class="grid gap-4 sm:grid-cols-3">
        {categories.map(({ key, label, icon, data }) => (
          <div class="card">
            <div class="flex items-center gap-3 mb-4">
              <span class="text-2xl">{icon}</span>
              <div>
                <h3 class="font-display font-semibold text-lg text-txt-primary">{label}</h3>
                <a href={`/${key}`} class="text-xs text-cyber hover:underline">View signals →</a>
              </div>
            </div>

            {data && data.overall.total > 0 ? (
              <div class="space-y-4">
                <!-- Accuracy Rate Circle -->
                <div class="flex items-center justify-center">
                  <div class="relative w-24 h-24">
                    <svg class="w-24 h-24 -rotate-90">
                      <circle
                        cx="48"
                        cy="48"
                        r="40"
                        stroke="currentColor"
                        stroke-width="8"
                        fill="none"
                        class="text-void-200"
                      />
                      <circle
                        cx="48"
                        cy="48"
                        r="40"
                        stroke="currentColor"
                        stroke-width="8"
                        fill="none"
                        stroke-dasharray={`${(data.overall.rate || 0) * 2.51} 251`}
                        class={data.overall.rate && data.overall.rate >= 60 ? "text-bullish" : data.overall.rate && data.overall.rate >= 50 ? "text-cyber" : "text-bearish"}
                      />
                    </svg>
                    <div class="absolute inset-0 flex items-center justify-center">
                      <span class="font-mono text-xl font-bold text-txt-primary">
                        {data.overall.rate ?? 0}%
                      </span>
                    </div>
                  </div>
                </div>

                <!-- Stats -->
                <div class="text-center text-sm text-txt-muted">
                  {data.overall.correct} / {data.overall.total} correct
                </div>

                <!-- Bias Breakdown -->
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                  <div class="p-2 rounded bg-bullish/10">
                    <div class="font-mono text-bullish">{data.byBias.Bullish.rate}%</div>
                    <div class="text-txt-muted">Bullish</div>
                  </div>
                  <div class="p-2 rounded bg-void-100">
                    <div class="font-mono text-txt-secondary">{data.byBias.Neutral.rate}%</div>
                    <div class="text-txt-muted">Neutral</div>
                  </div>
                  <div class="p-2 rounded bg-bearish/10">
                    <div class="font-mono text-bearish">{data.byBias.Bearish.rate}%</div>
                    <div class="text-txt-muted">Bearish</div>
                  </div>
                </div>
              </div>
            ) : (
              <div class="text-center py-6">
                <div class="relative w-24 h-24 mx-auto mb-3">
                  <svg class="w-24 h-24 -rotate-90">
                    <circle cx="48" cy="48" r="40" stroke="currentColor" stroke-width="8" fill="none" class="text-void-200"/>
                  </svg>
                  <div class="absolute inset-0 flex items-center justify-center">
                    <span class="font-mono text-sm text-txt-muted">Building</span>
                  </div>
                </div>
                <div class="text-sm text-txt-muted">Measuring accuracy</div>
                <div class="text-[10px] text-txt-muted/60 mt-1">Requires verified signal outcomes</div>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>

    <!-- Recent Outcomes Timeline -->
    {allRecent.length > 0 && (
      <div class="card" data-animate>
        <h2 class="font-display font-semibold text-lg text-txt-primary mb-4">Recent Outcomes</h2>
        <div class="space-y-3">
          {allRecent.map((outcome) => (
            <div class="flex items-center gap-3 py-2 border-b border-divider last:border-0">
              <!-- Status Icon -->
              <div class={`w-8 h-8 rounded-full flex items-center justify-center ${outcome.correct ? 'bg-bullish/20 text-bullish' : 'bg-bearish/20 text-bearish'}`}>
                {outcome.correct ? (
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                  </svg>
                ) : (
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                  </svg>
                )}
              </div>

              <!-- Details -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="text-sm font-medium text-txt-primary">{outcome.label}</span>
                  <span class={`text-xs px-2 py-0.5 rounded ${outcome.bias === 'Bullish' ? 'bg-bullish/10 text-bullish' : outcome.bias === 'Bearish' ? 'bg-bearish/10 text-bearish' : 'bg-void-100 text-txt-secondary'}`}>
                    {outcome.bias}
                  </span>
                </div>
                <div class="text-xs text-txt-muted">
                  {outcome.date} • {outcome.priceChange >= 0 ? '+' : ''}{outcome.priceChange}%
                </div>
              </div>

              <!-- Result -->
              <div class={`text-xs font-medium ${outcome.correct ? 'text-bullish' : 'text-bearish'}`}>
                {outcome.correct ? 'Correct' : 'Incorrect'}
              </div>
            </div>
          ))}
        </div>
      </div>
    )}

    <!-- Methodology Link -->
    <div class="card text-center py-8" data-animate>
      <h3 class="font-display font-semibold text-lg text-txt-primary mb-2">How We Measure Accuracy</h3>
      <p class="text-sm text-txt-muted mb-4 max-w-lg mx-auto">
        Signals are verified against next-day price movements. Bullish signals are correct if price rises,
        bearish if it falls. Neutral signals are considered correct if price moves less than 0.5%.
      </p>
      <a href="/about" class="text-cyber hover:underline text-sm">Learn more about our methodology →</a>
    </div>

    <!-- VIP Conviction Teaser -->
    <div class="card border-vip/20 text-center py-8" data-animate>
      <h3 class="font-display font-semibold text-lg text-txt-primary mb-2">Good signals aren't enough.</h3>
      <p class="text-sm text-txt-muted mb-4 max-w-lg mx-auto">
        Most traders don't lose because of bad calls—they lose because they can't hold through the dips.
        VIP shows you the whale activity, the AI debates, and the full reasoning. So you actually trust your positions.
      </p>
    </div>

    <!-- VIP CTA -->
    <VIPCTA category="performance" mode="waitlist" utmSource="performance_page" />

    <!-- Telegram CTA -->
    <TelegramCTA variant="compact" />
  </div>

  <Footer slot="footer" />
</BaseLayout>
