---
// src/pages/embed/[category].astro
// Embeddable widget for third-party sites (iframe-friendly)
import { getLatestSignal, getAssetSignals } from "../../lib/db";
import type { Category } from "../../lib/db";

const { category: catParam } = Astro.params;
const theme = Astro.url.searchParams.get("theme") || "dark";
const compact = Astro.url.searchParams.get("compact") === "true";

// Validate category
const validCategories = ["crypto", "forex", "stocks", "all"];
if (!catParam || !validCategories.includes(catParam)) {
  return Astro.redirect("/embed");
}

const db = Astro.locals.runtime?.env?.DB;

interface SignalData {
  category: Category;
  bias: string | null;
  date: string;
  time_slot: string;
  summary: string | null;
}

let signals: SignalData[] = [];

if (db) {
  const categories: Category[] = catParam === "all"
    ? ["crypto", "forex", "stocks"]
    : [catParam as Category];

  const results = await Promise.all(
    categories.map(async (cat) => {
      const signal = await getLatestSignal(db, cat);
      if (!signal) return null;

      let summary = null;
      if (signal.output_json) {
        try {
          const output = JSON.parse(signal.output_json);
          summary = output.summary || null;
        } catch {}
      }

      return {
        category: cat,
        bias: signal.bias,
        date: signal.date,
        time_slot: signal.time_slot,
        summary,
      };
    })
  );

  signals = results.filter((s): s is SignalData => s !== null);
}

const categoryLabels: Record<string, string> = {
  crypto: "Crypto",
  forex: "Forex",
  stocks: "Stocks",
};

const categoryIcons: Record<string, string> = {
  crypto: "â‚¿",
  forex: "$",
  stocks: "ðŸ“ˆ",
};

function getBiasColor(bias: string | null): string {
  if (!bias) return "#6b7280";
  const lower = bias.toLowerCase();
  if (lower.includes("bullish")) return "#22c55e";
  if (lower.includes("bearish")) return "#ef4444";
  return "#6b7280";
}

function getBiasEmoji(bias: string | null): string {
  if (!bias) return "âšª";
  const lower = bias.toLowerCase();
  if (lower.includes("bullish")) return "ðŸŸ¢";
  if (lower.includes("bearish")) return "ðŸ”´";
  return "ðŸŸ¡";
}

function formatTime(date: string, time: string): string {
  const now = new Date();
  const signalDate = new Date(`${date}T${time}:00Z`);
  const diffMs = now.getTime() - signalDate.getTime();
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));

  if (diffHours < 1) return "Just now";
  if (diffHours < 24) return `${diffHours}h ago`;
  return `${Math.floor(diffHours / 24)}d ago`;
}

// Prevent framing from unauthorized domains (optional security)
// Astro.response.headers.set("X-Frame-Options", "ALLOWALL");
---

<!DOCTYPE html>
<html lang="en" data-theme={theme}>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex">
  <title>EverInvests Widget</title>
  <style>
    :root {
      --bg: #ffffff;
      --bg-card: #f9fafb;
      --text: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --accent: #3b82f6;
    }

    [data-theme="dark"] {
      --bg: #0a0e17;
      --bg-card: #141a24;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --border: rgba(255,255,255,0.1);
      --accent: #00d4ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding: 12px;
      min-height: 100vh;
    }

    .widget {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      max-width: 320px;
    }

    .widget-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .widget-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }

    .widget-updated {
      font-size: 11px;
      color: var(--text-muted);
    }

    .signal-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .signal-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg);
      border-radius: 8px;
      text-decoration: none;
      color: inherit;
      transition: transform 0.15s ease;
    }

    .signal-item:hover {
      transform: translateX(4px);
    }

    .signal-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .signal-icon {
      font-size: 16px;
    }

    .signal-category {
      font-size: 13px;
      font-weight: 500;
    }

    .signal-bias {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }

    .bias-bullish {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
    }

    .bias-bearish {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
    }

    .bias-neutral {
      background: rgba(107, 114, 128, 0.15);
      color: #6b7280;
    }

    .widget-footer {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .powered-by {
      font-size: 11px;
      color: var(--text-muted);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .powered-by:hover {
      color: var(--accent);
    }

    .powered-by svg {
      width: 12px;
      height: 12px;
    }

    .view-all {
      font-size: 11px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
    }

    .view-all:hover {
      text-decoration: underline;
    }

    /* Compact mode */
    .widget.compact {
      padding: 12px;
    }

    .widget.compact .signal-item {
      padding: 8px 10px;
    }

    .widget.compact .signal-bias {
      font-size: 11px;
      padding: 3px 8px;
    }

    .no-signals {
      text-align: center;
      padding: 20px;
      color: var(--text-muted);
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class:list={["widget", { compact }]}>
    <div class="widget-header">
      <span class="widget-title">
        {catParam === "all" ? "Today's Signals" : `${categoryLabels[catParam]} Signals`}
      </span>
      {signals.length > 0 && (
        <span class="widget-updated">
          {formatTime(signals[0].date, signals[0].time_slot)}
        </span>
      )}
    </div>

    {signals.length > 0 ? (
      <div class="signal-list">
        {signals.map((signal) => (
          <a
            href={`https://everinvests.com/${signal.category}?utm_source=widget&utm_medium=embed`}
            target="_blank"
            rel="noopener"
            class="signal-item"
          >
            <div class="signal-info">
              <span class="signal-icon">{categoryIcons[signal.category]}</span>
              <span class="signal-category">{categoryLabels[signal.category]}</span>
            </div>
            <span class:list={[
              "signal-bias",
              signal.bias?.toLowerCase().includes("bullish") ? "bias-bullish" :
              signal.bias?.toLowerCase().includes("bearish") ? "bias-bearish" : "bias-neutral"
            ]}>
              {getBiasEmoji(signal.bias)} {signal.bias || "Loading"}
            </span>
          </a>
        ))}
      </div>
    ) : (
      <div class="no-signals">
        No signals available
      </div>
    )}

    <div class="widget-footer">
      <a
        href="https://everinvests.com?utm_source=widget&utm_medium=embed"
        target="_blank"
        rel="noopener"
        class="powered-by"
      >
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
        </svg>
        Powered by EverInvests
      </a>
      <a
        href="https://everinvests.com?utm_source=widget&utm_medium=embed"
        target="_blank"
        rel="noopener"
        class="view-all"
      >
        View all â†’
      </a>
    </div>
  </div>

  <script>
    // Track widget view with referrer domain
    const category = document.querySelector('.widget')?.closest('[data-category]')?.getAttribute('data-category')
      || new URLSearchParams(window.location.search).get('category')
      || window.location.pathname.split('/').pop();

    fetch('https://everinvests.com/api/track', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        event: 'widget_view',
        category: category,
        source: 'embed',
        meta: {
          referrer: document.referrer || 'direct',
          referrerDomain: document.referrer ? new URL(document.referrer).hostname : 'direct'
        }
      })
    }).catch(() => {});
  </script>
</body>
</html>
