---
// src/pages/forex/index.astro
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import MacroBar from "../../components/MacroBar.astro";
import SignalDetail from "../../components/SignalDetail.astro";
import AssetTable from "../../components/AssetTable.astro";
import HistoryMini from "../../components/HistoryMini.astro";
import TelegramCTA from "../../components/TelegramCTA.astro";
import { getLatestMacro, getLatestSignal, getAssetSignals, getSignalHistory } from "../../lib/db";

const category = "forex" as const;
const categoryTitle = "Forex";
const categoryDescription = "Daily forex signals for USD/JPY, EUR/USD, USD/CAD, AUD/USD with RSI and MA analysis.";

const db = Astro.locals.runtime?.env?.DB;

let macro = null;
let signal = null;
let assets: any[] = [];
let history: any[] = [];

if (db) {
  [macro, signal] = await Promise.all([
    getLatestMacro(db),
    getLatestSignal(db, category),
  ]);

  if (signal) {
    [assets, history] = await Promise.all([
      getAssetSignals(db, signal.id),
      getSignalHistory(db, category, 7),
    ]);
  }
}
---

<BaseLayout title={categoryTitle} description={categoryDescription}>
  <Header slot="header" />

  <div class="space-y-8">
    <!-- Breadcrumb -->
    <nav class="flex items-center gap-2 text-sm" data-animate>
      <a href="/" class="text-txt-muted hover:text-txt-primary transition-colors">Home</a>
      <svg class="w-4 h-4 text-txt-muted/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
      </svg>
      <span class="text-txt-primary font-medium">{categoryTitle}</span>
    </nav>

    <!-- Page Header -->
    <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4" data-animate>
      <div>
        <div class="flex items-center gap-3 mb-2">
          <span class="text-3xl">$</span>
          <h1 class="font-display font-bold text-3xl sm:text-4xl text-txt-primary">{categoryTitle} Signals</h1>
        </div>
        <p class="text-txt-secondary">USD/JPY, EUR/USD, USD/CAD, AUD/USD with RSI analysis</p>
      </div>
      <TelegramCTA variant="compact" />
    </div>

    <!-- Macro Context -->
    <MacroBar
      overall={macro?.overall}
      dxyBias={macro?.dxy_bias}
      vixLevel={macro?.vix_level}
      yieldsBias={macro?.yields_bias}
    />

    <!-- Current Signal -->
    {signal ? (
      <SignalDetail signal={signal} />
    ) : (
      <div class="card text-center py-16" data-animate>
        <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-void-100 flex items-center justify-center">
          <svg class="w-8 h-8 text-txt-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="font-display font-semibold text-lg text-txt-primary mb-2">No Signal Yet</h3>
        <p class="text-txt-muted">Check back at the next scheduled update.</p>
      </div>
    )}

    <!-- Asset Table -->
    {assets.length > 0 && (
      <div class="card" data-animate>
        <h2 class="font-display font-semibold text-lg text-txt-primary mb-4">Currency Pairs</h2>
        <AssetTable assets={assets} category={category} />
      </div>
    )}

    <!-- History Mini -->
    <div class="card" data-animate>
      <HistoryMini signals={history} category={category} />
    </div>
  </div>

  <Footer slot="footer" />
</BaseLayout>
